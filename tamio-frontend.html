<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tamio - Cash Flow Onboarding</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .progress-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }

        .progress-bar::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #e0e0e0;
            z-index: 0;
        }

        .progress-step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #999;
            position: relative;
            z-index: 1;
        }

        .progress-step.active {
            background: #667eea;
            color: white;
        }

        .progress-step.completed {
            background: #4caf50;
            color: white;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
            margin-right: 10px;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-add {
            background: #4caf50;
            color: white;
            margin-top: 10px;
        }

        .btn-add:hover {
            background: #45a049;
        }

        .card {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .card-title {
            font-weight: 600;
            color: #333;
        }

        .btn-remove {
            background: #f44336;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-remove:hover {
            background: #da190b;
        }

        .buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }

        .hidden {
            display: none;
        }

        .forecast-result {
            margin-top: 30px;
        }

        .forecast-week {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .forecast-week.negative {
            border-left-color: #f44336;
        }

        .forecast-summary {
            background: #667eea;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .summary-stat {
            display: inline-block;
            margin-right: 30px;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 600px) {
            .row {
                grid-template-columns: 1fr;
            }
        }

        .total-display {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: #2e7d32;
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .success {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin: 30px 0;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .chart-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .chart-tab {
            padding: 10px 20px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .chart-tab.active {
            background: #667eea;
            color: white;
        }

        .forecast-week {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .forecast-week:hover {
            background: #e9ecef;
            transform: translateX(5px);
        }

        .forecast-week.negative {
            border-left-color: #f44336;
            background: #ffebee;
        }

        .forecast-week.negative:hover {
            background: #ffcdd2;
        }

        .week-details {
            display: none;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ddd;
        }

        .week-details.expanded {
            display: block;
        }

        .event-item {
            padding: 8px;
            background: white;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 14px;
        }

        .event-in {
            border-left: 3px solid #4caf50;
        }

        .event-out {
            border-left: 3px solid #f44336;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .btn-export {
            padding: 10px 20px;
            background: #4caf50;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-export:hover {
            background: #45a049;
        }

        /* ============================================================
           TAMI CHAT PANEL STYLES
           ============================================================ */
        .tami-panel {
            margin-top: 30px;
            border: 2px solid #667eea;
            border-radius: 12px;
            overflow: hidden;
            background: #f8f9ff;
        }

        .tami-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .tami-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tami-status {
            font-size: 12px;
            background: rgba(255,255,255,0.2);
            padding: 4px 10px;
            border-radius: 12px;
        }

        .tami-messages {
            height: 350px;
            overflow-y: auto;
            padding: 20px;
            background: white;
        }

        .tami-message {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }

        .tami-message.user {
            flex-direction: row-reverse;
        }

        .tami-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .tami-avatar.tami {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .tami-avatar.user {
            background: #e0e0e0;
        }

        .tami-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.5;
        }

        .tami-message.tami .tami-bubble {
            background: #f0f4ff;
            border: 1px solid #e0e8ff;
            border-bottom-left-radius: 4px;
        }

        .tami-message.user .tami-bubble {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .tami-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .tami-action-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #667eea;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .tami-action-btn:hover {
            background: #667eea;
            color: white;
        }

        .tami-input-area {
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .tami-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #e0e0e0;
            border-radius: 24px;
            font-size: 14px;
            outline: none;
        }

        .tami-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .tami-send-btn {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .tami-send-btn:hover {
            background: #5568d3;
        }

        .tami-send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .scenario-banner {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 14px;
        }

        .scenario-banner.hidden {
            display: none;
        }

        .scenario-banner-actions {
            display: flex;
            gap: 10px;
        }

        .scenario-banner-btn {
            padding: 6px 14px;
            border-radius: 16px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border: none;
        }

        .scenario-banner-btn.apply {
            background: white;
            color: #f57c00;
        }

        .scenario-banner-btn.discard {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        .tami-typing {
            display: flex;
            gap: 4px;
            padding: 8px 16px;
        }

        .tami-typing-dot {
            width: 8px;
            height: 8px;
            background: #667eea;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .tami-typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .tami-typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
            30% { transform: translateY(-4px); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Tamio Cash Flow Onboarding</h1>
        <p class="subtitle">Set up your 13-week cash flow forecast in 3 simple steps</p>

        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-step active" id="step1">1</div>
            <div class="progress-step" id="step2">2</div>
            <div class="progress-step" id="step3">3</div>
        </div>

        <!-- Page 1: Cash Position -->
        <div class="page active" id="page1">
            <h2>Page 1: Current Cash Position</h2>
            <p class="subtitle">Add your current cash accounts</p>

            <div id="accountsList"></div>

            <div class="form-group">
                <label>Account Name</label>
                <input type="text" id="accountName" placeholder="e.g., Business Checking">
            </div>

            <div class="row">
                <div class="form-group">
                    <label>Balance</label>
                    <input type="number" id="accountBalance" placeholder="100000" step="0.01">
                </div>
                <div class="form-group">
                    <label>Currency</label>
                    <select id="accountCurrency">
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                        <option value="GBP">GBP</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>As of Date</label>
                <input type="date" id="accountDate" value="">
            </div>

            <button class="btn btn-add" onclick="addAccount()">+ Add Account</button>

            <div id="totalCash" class="total-display hidden">
                Total Starting Cash: $<span id="totalAmount">0</span>
            </div>

            <div class="buttons">
                <div></div>
                <button class="btn btn-primary" onclick="nextPage()">Next: Add Clients ‚Üí</button>
            </div>
        </div>

        <!-- Page 2: Clients (Cash In) -->
        <div class="page" id="page2">
            <h2>Page 2: Cash In (Clients)</h2>
            <p class="subtitle">Add your revenue sources</p>

            <div id="clientsList"></div>

            <div class="form-group">
                <label>Client Name</label>
                <input type="text" id="clientName" placeholder="e.g., Acme Corp">
            </div>

            <div class="row">
                <div class="form-group">
                    <label>Client Type</label>
                    <select id="clientType" onchange="updateBillingConfig()">
                        <option value="retainer">Retainer</option>
                        <option value="project">Project</option>
                        <option value="usage">Usage-Based</option>
                        <option value="mixed">Mixed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Currency</label>
                    <select id="clientCurrency">
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                        <option value="GBP">GBP</option>
                    </select>
                </div>
            </div>

            <div id="billingConfigSection">
                <!-- Dynamic billing config will be inserted here -->
            </div>

            <button class="btn btn-add" onclick="addClient()">+ Add Client</button>

            <div class="buttons">
                <button class="btn btn-secondary" onclick="prevPage()">‚Üê Back</button>
                <button class="btn btn-primary" onclick="nextPage()">Next: Add Expenses ‚Üí</button>
            </div>
        </div>

        <!-- Page 3: Expenses (Cash Out) -->
        <div class="page" id="page3">
            <h2>Page 3: Cash Out (Expenses)</h2>
            <p class="subtitle">Add your expense buckets</p>

            <div id="expensesList"></div>

            <div class="form-group">
                <label>Expense Name</label>
                <input type="text" id="expenseName" placeholder="e.g., Payroll">
            </div>

            <div class="row">
                <div class="form-group">
                    <label>Category</label>
                    <select id="expenseCategory">
                        <option value="payroll">Payroll</option>
                        <option value="rent">Rent</option>
                        <option value="contractors">Contractors</option>
                        <option value="software">Software</option>
                        <option value="marketing">Marketing</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Type</label>
                    <select id="expenseType">
                        <option value="fixed">Fixed</option>
                        <option value="variable">Variable</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="form-group">
                    <label>Monthly Amount</label>
                    <input type="number" id="expenseAmount" placeholder="25000" step="0.01">
                </div>
                <div class="form-group">
                    <label>Priority</label>
                    <select id="expensePriority">
                        <option value="essential">Essential</option>
                        <option value="important" selected>Important</option>
                        <option value="discretionary">Discretionary</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="form-group">
                    <label>Payment Due Day of Month</label>
                    <select id="expenseDueDay">
                        <option value="1">1st (Start of month)</option>
                        <option value="15" selected>15th (Mid-month)</option>
                        <option value="28">28th (End of month)</option>
                        <option value="31">Last day of month</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Payment Frequency</label>
                    <select id="expenseFrequency">
                        <option value="monthly" selected>Monthly</option>
                        <option value="bi-weekly">Bi-weekly</option>
                        <option value="weekly">Weekly</option>
                        <option value="quarterly">Quarterly</option>
                    </select>
                </div>
            </div>
            <p style="font-size: 12px; color: #666; margin-top: -10px; margin-bottom: 15px;">
                üí° When is this expense typically due each month? This helps us accurately forecast cash outflows.
            </p>

            <button class="btn btn-add" onclick="addExpense()">+ Add Expense Bucket</button>

            <!-- Cash Buffer Rule Section -->
            <div style="margin-top: 40px; padding-top: 30px; border-top: 2px solid #dc3545;">
                <h3 style="color: #dc3545; margin-bottom: 10px;">üõ°Ô∏è Cash Buffer Rule (Safety Net)</h3>
                <p style="color: #666; margin-bottom: 20px;">
                    Set your minimum cash buffer requirement. This is the amount you need to keep in the bank at all times
                    to feel safe. We'll show this as a red line on your forecast and warn you if you're at risk of going below it.
                </p>

                <div class="row">
                    <div class="form-group">
                        <label>Buffer Type</label>
                        <select id="bufferType" onchange="updateBufferPreview()">
                            <option value="months">Months of Runway</option>
                            <option value="fixed">Fixed Amount</option>
                        </select>
                    </div>
                    <div class="form-group" id="bufferMonthsGroup">
                        <label>Number of Months</label>
                        <select id="bufferMonths" onchange="updateBufferPreview()">
                            <option value="1">1 month</option>
                            <option value="2">2 months</option>
                            <option value="3" selected>3 months (Recommended)</option>
                            <option value="4">4 months</option>
                            <option value="6">6 months</option>
                        </select>
                    </div>
                    <div class="form-group" id="bufferFixedGroup" style="display: none;">
                        <label>Fixed Buffer Amount ($)</label>
                        <input type="number" id="bufferFixedAmount" placeholder="150000" step="1000" onchange="updateBufferPreview()">
                    </div>
                </div>

                <div id="bufferPreview" style="background: #fff3f3; border: 2px solid #dc3545; border-radius: 8px; padding: 15px; margin-top: 15px;">
                    <strong style="color: #dc3545;">Your Cash Buffer:</strong>
                    <span id="bufferPreviewText">Calculating based on your expenses...</span>
                </div>
            </div>

            <div class="buttons">
                <button class="btn btn-secondary" onclick="prevPage()">‚Üê Back</button>
                <button class="btn btn-primary" onclick="submitOnboarding()">Generate Forecast üöÄ</button>
            </div>
        </div>

        <!-- Page 4: Results -->
        <div class="page" id="page4">
            <div id="loadingSection" class="loading">
                <div class="spinner"></div>
                <p style="margin-top: 20px;">Generating your 13-week forecast...</p>
            </div>

            <div id="resultSection" class="hidden">
                <h2>Your 13-Week Cash Flow Forecast</h2>
                <div id="forecastSummary"></div>

                <!-- Chart Tabs -->
                <div class="chart-tabs">
                    <button class="chart-tab active" onclick="showChart('balance')">üí∞ Cash Balance</button>
                    <button class="chart-tab" onclick="showChart('cashflow')">üìä Cash Flow</button>
                </div>

                <!-- Chart Container -->
                <div class="chart-container">
                    <canvas id="forecastChart"></canvas>
                </div>

                <!-- Export Buttons -->
                <div class="export-buttons">
                    <button class="btn-export" onclick="exportCSV()">üì• Download CSV</button>
                    <button class="btn-export" onclick="exportJSON()">üìÑ Download JSON</button>
                </div>

                <!-- TAMI Chat Panel -->
                <div class="tami-panel" id="tamiPanel">
                    <!-- Scenario Mode Banner -->
                    <div class="scenario-banner hidden" id="scenarioBanner">
                        <span>üìä <strong>Scenario Mode:</strong> <span id="scenarioBannerName">Viewing scenario</span></span>
                        <div class="scenario-banner-actions">
                            <button class="scenario-banner-btn apply" onclick="tamiConfirmScenario()">‚úì Confirm</button>
                            <button class="scenario-banner-btn discard" onclick="tamiDiscardScenario()">‚úó Discard</button>
                        </div>
                    </div>

                    <!-- Header -->
                    <div class="tami-header">
                        <h3>ü§ñ TAMI</h3>
                        <span class="tami-status" id="tamiStatus">Ready</span>
                    </div>

                    <!-- Messages -->
                    <div class="tami-messages" id="tamiMessages">
                        <div class="tami-message tami">
                            <div class="tami-avatar tami">ü§ñ</div>
                            <div class="tami-bubble">
                                <strong>Hi, I'm TAMI!</strong> I can help you understand your cash flow forecast and explore what-if scenarios.
                                <br><br>
                                Try asking me things like:
                                <ul style="margin: 8px 0 0 16px; padding: 0;">
                                    <li>"What happens if I lose a client?"</li>
                                    <li>"When does my cash buffer breach?"</li>
                                    <li>"How can I extend my runway?"</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Input Area -->
                    <div class="tami-input-area">
                        <input type="text" class="tami-input" id="tamiInput"
                               placeholder="Ask TAMI about your forecast..."
                               onkeypress="if(event.key === 'Enter') sendTamiMessage()">
                        <button class="tami-send-btn" id="tamiSendBtn" onclick="sendTamiMessage()">Send</button>
                    </div>
                </div>

                <!-- Week Details -->
                <h3 style="margin-top: 30px; margin-bottom: 15px;">Week-by-Week Breakdown</h3>
                <div id="forecastWeeks"></div>

                <!-- Manage Data Section -->
                <div id="manageDataSection" style="margin-top: 50px; border-top: 2px solid #28a745; padding-top: 30px;">
                    <h2>üìù Manage Your Data</h2>
                    <p style="color: #666; margin-bottom: 20px;">Edit, add, or remove clients and expenses. Changes will regenerate your forecast.</p>

                    <!-- Data Tabs -->
                    <div class="chart-tabs" style="margin-bottom: 20px;">
                        <button class="chart-tab active" id="clientsTab" onclick="showDataTab('clients')">üë• Clients</button>
                        <button class="chart-tab" id="expensesTab" onclick="showDataTab('expenses')">üí∏ Expenses</button>
                        <button class="chart-tab" id="integrationsTab" onclick="showDataTab('integrations')">üîó Integrations</button>
                    </div>

                    <!-- Clients Management -->
                    <div id="manageClientsSection">
                        <div id="manageClientsList" style="margin-bottom: 20px;"></div>

                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin-top: 0;">+ Add New Client</h4>

                            <div class="form-group">
                                <label>Client Name</label>
                                <input type="text" id="manageClientName" placeholder="e.g., Acme Corp">
                            </div>

                            <div class="row">
                                <div class="form-group">
                                    <label>Client Type</label>
                                    <select id="manageClientType" onchange="updateManageBillingConfig()">
                                        <option value="retainer">Retainer</option>
                                        <option value="project">Project</option>
                                        <option value="usage">Usage-Based</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Currency</label>
                                    <select id="manageClientCurrency">
                                        <option value="USD">USD</option>
                                        <option value="EUR">EUR</option>
                                        <option value="GBP">GBP</option>
                                    </select>
                                </div>
                            </div>

                            <div id="manageBillingConfigSection"></div>

                            <button class="btn btn-add" onclick="addManagedClient()">+ Add Client</button>
                        </div>
                    </div>

                    <!-- Expenses Management -->
                    <div id="manageExpensesSection" style="display: none;">
                        <div id="manageExpensesList" style="margin-bottom: 20px;"></div>

                        <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin-top: 0;">+ Add New Expense</h4>

                            <div class="form-group">
                                <label>Expense Name</label>
                                <input type="text" id="manageExpenseName" placeholder="e.g., Office Rent">
                            </div>

                            <div class="row">
                                <div class="form-group">
                                    <label>Category</label>
                                    <select id="manageExpenseCategory">
                                        <option value="payroll">Payroll</option>
                                        <option value="rent">Rent</option>
                                        <option value="contractors">Contractors</option>
                                        <option value="software">Software</option>
                                        <option value="marketing">Marketing</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Type</label>
                                    <select id="manageExpenseType">
                                        <option value="fixed">Fixed</option>
                                        <option value="variable">Variable</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="form-group">
                                    <label>Monthly Amount</label>
                                    <input type="number" id="manageExpenseAmount" placeholder="5000" step="0.01">
                                </div>
                                <div class="form-group">
                                    <label>Priority</label>
                                    <select id="manageExpensePriority">
                                        <option value="essential">Essential</option>
                                        <option value="important" selected>Important</option>
                                        <option value="discretionary">Discretionary</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="form-group">
                                    <label>Payment Due Day</label>
                                    <select id="manageExpenseDueDay">
                                        <option value="1">1st</option>
                                        <option value="15" selected>15th</option>
                                        <option value="28">28th</option>
                                        <option value="31">Last day</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Frequency</label>
                                    <select id="manageExpenseFrequency">
                                        <option value="monthly" selected>Monthly</option>
                                        <option value="bi-weekly">Bi-weekly</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="quarterly">Quarterly</option>
                                    </select>
                                </div>
                            </div>

                            <button class="btn btn-add" onclick="addManagedExpense()">+ Add Expense</button>
                        </div>
                    </div>

                    <!-- Integrations Section -->
                    <div id="manageIntegrationsSection" style="display: none;">
                        <div id="xeroIntegration" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
                                <img src="https://www.xero.com/content/dam/xero/pilot-images/cta/xero-logo.svg" alt="Xero" style="height: 40px;" onerror="this.style.display='none'">
                                <div>
                                    <h4 style="margin: 0;">Xero Accounting</h4>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">Import clients and invoices from Xero</p>
                                </div>
                            </div>

                            <div id="xeroStatus" style="padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #e9ecef;">
                                <span id="xeroStatusText">Checking connection status...</span>
                            </div>

                            <div id="xeroNotConnected">
                                <p style="color: #666; margin-bottom: 15px;">
                                    Connect your Xero account to automatically import:
                                </p>
                                <ul style="color: #666; margin-bottom: 20px; padding-left: 20px;">
                                    <li>Customers ‚Üí Clients with payment history</li>
                                    <li>Invoices ‚Üí Cash inflow events</li>
                                    <li>Bills ‚Üí Cash outflow events</li>
                                    <li>Repeating invoices ‚Üí Retainer detection</li>
                                </ul>
                                <button class="btn btn-primary" onclick="connectXero()" style="background: #13B5EA;">
                                    üîó Connect to Xero
                                </button>
                            </div>

                            <div id="xeroConnected" style="display: none;">
                                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                    <button class="btn btn-primary" onclick="previewXeroData()" style="background: #13B5EA;">
                                        üëÅÔ∏è Preview Data
                                    </button>
                                    <button class="btn btn-add" onclick="syncXeroData()">
                                        üîÑ Sync Now
                                    </button>
                                    <button class="btn btn-secondary" onclick="viewXeroSyncHistory()">
                                        üìã Sync History
                                    </button>
                                    <button class="btn btn-remove" onclick="disconnectXero()">
                                        Disconnect
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Xero Preview Modal Content Area -->
                        <div id="xeroPreviewArea" style="display: none; background: white; border: 2px solid #13B5EA; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="margin: 0;">üìä Xero Data Preview</h4>
                                <button onclick="hideXeroPreview()" style="background: none; border: none; font-size: 20px; cursor: pointer;">√ó</button>
                            </div>
                            <div id="xeroPreviewContent">Loading...</div>
                            <div style="margin-top: 20px; text-align: right;">
                                <button class="btn btn-secondary" onclick="hideXeroPreview()">Cancel</button>
                                <button class="btn btn-add" onclick="syncXeroData()">Import This Data</button>
                            </div>
                        </div>

                        <!-- Sync History Area -->
                        <div id="xeroHistoryArea" style="display: none; background: white; border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                <h4 style="margin: 0;">üìã Sync History</h4>
                                <button onclick="hideXeroHistory()" style="background: none; border: none; font-size: 20px; cursor: pointer;">√ó</button>
                            </div>
                            <div id="xeroHistoryContent">Loading...</div>
                        </div>
                    </div>

                    <button class="btn btn-primary" onclick="regenerateForecast()" style="margin-top: 10px;">üîÑ Regenerate Forecast with Changes</button>
                </div>

                <!-- Scenario Analysis Section -->
                <div id="scenarioSection" style="margin-top: 50px; border-top: 2px solid #667eea; padding-top: 30px;">
                    <h2>üéØ Scenario Analysis (What-If Modeling)</h2>
                    <p style="color: #666; margin-bottom: 20px;">Explore "what if" scenarios to understand how decisions might impact your cash flow.</p>

                    <button class="btn btn-primary" onclick="showScenarioBuilder()" style="margin-bottom: 20px;">+ Create New Scenario</button>

                    <!-- Scenario Builder (Hidden initially) -->
                    <div id="scenarioBuilder" class="hidden" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3>Create Scenario</h3>

                        <div class="form-group">
                            <label>Scenario Name</label>
                            <input type="text" id="scenarioName" placeholder="e.g., 'Hire 2 Engineers'">
                        </div>

                        <div class="form-group">
                            <label>Scenario Type</label>
                            <select id="scenarioType" onchange="updateScenarioFields()">
                                <option value="">-- Select Type --</option>
                                <optgroup label="Cash In">
                                    <option value="payment_delay">Payment Delay</option>
                                    <option value="client_loss">Client Loss</option>
                                    <option value="client_gain">New Client</option>
                                    <option value="client_change">Client Change (Upsell/Downsell)</option>
                                </optgroup>
                                <optgroup label="Cash Out">
                                    <option value="hiring">Hiring</option>
                                    <option value="firing">Firing</option>
                                    <option value="increased_expense">Increase Expense</option>
                                    <option value="decreased_expense">Decrease Expense</option>
                                </optgroup>
                            </select>
                        </div>

                        <div id="scenarioParameters" style="margin-top: 20px;">
                            <!-- Dynamic fields based on scenario type -->
                        </div>

                        <div class="buttons">
                            <button class="btn btn-secondary" onclick="hideScenarioBuilder()">Cancel</button>
                            <button class="btn btn-primary" onclick="buildScenario()">Build Scenario</button>
                        </div>
                    </div>

                    <!-- Active Scenarios List -->
                    <div id="scenariosList">
                        <!-- Will be populated with scenarios -->
                    </div>
                </div>

                <button class="btn btn-primary" onclick="startOver()" style="margin-top: 30px;">Start Over</button>
            </div>

            <div id="errorSection" class="hidden">
                <div class="error">
                    <strong>Error:</strong> <span id="errorMessage"></span>
                </div>
                <button class="btn btn-secondary" onclick="prevPage()">‚Üê Go Back</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const API_BASE = 'http://localhost:8000/api';

        // State
        let currentPage = 1;
        let userData = {
            email: `user${Date.now()}@example.com`,
            base_currency: 'USD'
        };
        let accounts = [];
        let clients = [];
        let expenses = [];

        // Set today's date as default
        document.getElementById('accountDate').valueAsDate = new Date();

        // Initialize billing config
        updateBillingConfig();

        // Handle Xero OAuth callback on page load
        handleXeroCallback();

        // Navigation
        function nextPage() {
            if (currentPage === 1 && accounts.length === 0) {
                alert('Please add at least one cash account');
                return;
            }

            document.getElementById(`page${currentPage}`).classList.remove('active');
            document.getElementById(`step${currentPage}`).classList.remove('active');
            document.getElementById(`step${currentPage}`).classList.add('completed');

            currentPage++;

            document.getElementById(`page${currentPage}`).classList.add('active');
            document.getElementById(`step${currentPage}`).classList.add('active');
        }

        function prevPage() {
            document.getElementById(`page${currentPage}`).classList.remove('active');
            document.getElementById(`step${currentPage}`).classList.remove('active');

            currentPage--;

            document.getElementById(`page${currentPage}`).classList.add('active');
            document.getElementById(`step${currentPage}`).classList.remove('completed');
            document.getElementById(`step${currentPage}`).classList.add('active');
        }

        // Page 1: Cash Accounts
        function addAccount() {
            const name = document.getElementById('accountName').value;
            const balance = parseFloat(document.getElementById('accountBalance').value);
            const currency = document.getElementById('accountCurrency').value;
            const asOfDate = document.getElementById('accountDate').value;

            if (!name || !balance || !asOfDate) {
                alert('Please fill in all account fields');
                return;
            }

            accounts.push({
                account_name: name,
                balance: balance,
                currency: currency,
                as_of_date: asOfDate
            });

            renderAccounts();

            // Clear form
            document.getElementById('accountName').value = '';
            document.getElementById('accountBalance').value = '';
        }

        function removeAccount(index) {
            accounts.splice(index, 1);
            renderAccounts();
        }

        function renderAccounts() {
            const list = document.getElementById('accountsList');
            const total = accounts.reduce((sum, acc) => sum + acc.balance, 0);

            list.innerHTML = accounts.map((acc, i) => `
                <div class="card">
                    <div class="card-header">
                        <span class="card-title">${acc.account_name}</span>
                        <button class="btn btn-remove" onclick="removeAccount(${i})">Remove</button>
                    </div>
                    <div>${acc.currency} ${acc.balance.toLocaleString()} ‚Ä¢ As of ${acc.as_of_date}</div>
                </div>
            `).join('');

            if (accounts.length > 0) {
                document.getElementById('totalCash').classList.remove('hidden');
                document.getElementById('totalAmount').textContent = total.toLocaleString();
            } else {
                document.getElementById('totalCash').classList.add('hidden');
            }
        }

        // Page 2: Clients
        function updateBillingConfig() {
            const type = document.getElementById('clientType').value;
            const section = document.getElementById('billingConfigSection');

            let html = '';

            if (type === 'retainer') {
                html = `
                    <div class="row">
                        <div class="form-group">
                            <label>Billing Frequency</label>
                            <select id="billingFrequency">
                                <option value="monthly">Monthly</option>
                                <option value="quarterly">Quarterly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Amount</label>
                            <input type="number" id="billingAmount" placeholder="10000" step="0.01">
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group">
                            <label>Average Invoice Day of Month</label>
                            <select id="invoiceDay">
                                <option value="1">1st (Start of month)</option>
                                <option value="15">15th (Mid-month)</option>
                                <option value="28">28th (End of month)</option>
                                <option value="custom">Custom day...</option>
                            </select>
                        </div>
                        <div class="form-group" id="customInvoiceDayGroup" style="display: none;">
                            <label>Custom Day (1-28)</label>
                            <input type="number" id="customInvoiceDay" min="1" max="28" placeholder="1">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Payment Terms</label>
                        <select id="paymentTerms">
                            <option value="net_7">Net 7 (Payment due 7 days after invoice)</option>
                            <option value="net_14">Net 14 (Payment due 14 days after invoice)</option>
                            <option value="net_30" selected>Net 30 (Payment due 30 days after invoice)</option>
                            <option value="net_45">Net 45 (Payment due 45 days after invoice)</option>
                            <option value="net_60">Net 60 (Payment due 60 days after invoice)</option>
                        </select>
                    </div>
                    <p style="font-size: 12px; color: #666; margin-top: 5px;">
                        üí° Payment expected: Invoice day + payment terms (e.g., invoiced on 1st with Net 30 = payment ~31st)
                    </p>
                `;
            } else if (type === 'project') {
                html = `
                    <div class="form-group">
                        <label>Total Project Value</label>
                        <input type="number" id="projectValue" placeholder="50000" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Milestone 1: Deposit</label>
                        <div class="row">
                            <input type="number" id="milestone1Amount" placeholder="Amount" step="0.01">
                            <input type="date" id="milestone1Date">
                        </div>
                    </div>
                `;
            } else if (type === 'usage') {
                html = `
                    <div class="row">
                        <div class="form-group">
                            <label>Settlement Frequency</label>
                            <select id="settlementFrequency">
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Typical Amount</label>
                            <input type="number" id="typicalAmount" placeholder="5000" step="0.01">
                        </div>
                    </div>
                `;
            }

            section.innerHTML = html;

            // Add event listener for custom invoice day toggle
            if (type === 'retainer') {
                const invoiceDaySelect = document.getElementById('invoiceDay');
                if (invoiceDaySelect) {
                    invoiceDaySelect.addEventListener('change', function() {
                        const customGroup = document.getElementById('customInvoiceDayGroup');
                        if (customGroup) {
                            customGroup.style.display = this.value === 'custom' ? 'block' : 'none';
                        }
                    });
                }
            }
        }

        function addClient() {
            const name = document.getElementById('clientName').value;
            const type = document.getElementById('clientType').value;
            const currency = document.getElementById('clientCurrency').value;

            if (!name) {
                alert('Please enter client name');
                return;
            }

            let billingConfig = {};

            if (type === 'retainer') {
                const amount = parseFloat(document.getElementById('billingAmount').value);
                if (!amount) {
                    alert('Please enter billing amount');
                    return;
                }

                // Get invoice day
                let invoiceDay = document.getElementById('invoiceDay').value;
                if (invoiceDay === 'custom') {
                    invoiceDay = parseInt(document.getElementById('customInvoiceDay').value) || 1;
                } else {
                    invoiceDay = parseInt(invoiceDay);
                }

                billingConfig = {
                    frequency: document.getElementById('billingFrequency').value,
                    invoice_day: invoiceDay,
                    amount: amount,
                    payment_terms: document.getElementById('paymentTerms').value
                };
            } else if (type === 'project') {
                const totalValue = parseFloat(document.getElementById('projectValue').value);
                const milestone1Amount = parseFloat(document.getElementById('milestone1Amount').value);
                const milestone1Date = document.getElementById('milestone1Date').value;

                if (!totalValue || !milestone1Amount || !milestone1Date) {
                    alert('Please fill in project details');
                    return;
                }

                billingConfig = {
                    total_value: totalValue,
                    payment_structure: "milestone",
                    milestones: [{
                        name: "Deposit",
                        amount: milestone1Amount,
                        expected_date: milestone1Date,
                        trigger_type: "date",
                        payment_terms: "net_7"
                    }]
                };
            } else if (type === 'usage') {
                const amount = parseFloat(document.getElementById('typicalAmount').value);
                if (!amount) {
                    alert('Please enter typical amount');
                    return;
                }
                billingConfig = {
                    settlement_frequency: document.getElementById('settlementFrequency').value,
                    typical_amount: amount,
                    payment_terms: "net_30"
                };
            }

            clients.push({
                name: name,
                client_type: type,
                currency: currency,
                status: "active",
                payment_behavior: "on_time",
                churn_risk: "low",
                scope_risk: "low",
                billing_config: billingConfig
            });

            renderClients();

            // Clear form
            document.getElementById('clientName').value = '';
        }

        function removeClient(index) {
            clients.splice(index, 1);
            renderClients();
        }

        function renderClients() {
            const list = document.getElementById('clientsList');

            list.innerHTML = clients.map((client, i) => {
                let details = `Type: ${client.client_type} ‚Ä¢ ${client.currency}`;

                // Add billing info based on type
                if (client.client_type === 'retainer' && client.billing_config) {
                    const invoiceDay = client.billing_config.invoice_day || 1;
                    const terms = client.billing_config.payment_terms || 'net_30';
                    const termsNum = parseInt(terms.replace('net_', ''));
                    const expectedDay = Math.min(invoiceDay + termsNum, 28);
                    details += `<br>$${client.billing_config.amount?.toLocaleString() || 0}/${client.billing_config.frequency}`;
                    details += `<br><small style="color: #666;">Invoice: Day ${invoiceDay} ‚Üí Payment expected: ~Day ${expectedDay} (${terms.replace('_', ' ')})</small>`;
                } else if (client.client_type === 'project' && client.billing_config) {
                    details += `<br>Project value: $${client.billing_config.total_value?.toLocaleString() || 0}`;
                } else if (client.client_type === 'usage' && client.billing_config) {
                    details += `<br>~$${client.billing_config.typical_amount?.toLocaleString() || 0}/${client.billing_config.settlement_frequency}`;
                }

                return `
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">${client.name}</span>
                            <button class="btn btn-remove" onclick="removeClient(${i})">Remove</button>
                        </div>
                        <div>${details}</div>
                    </div>
                `;
            }).join('');
        }

        // Page 3: Expenses
        function addExpense() {
            const name = document.getElementById('expenseName').value;
            const category = document.getElementById('expenseCategory').value;
            const type = document.getElementById('expenseType').value;
            const amount = parseFloat(document.getElementById('expenseAmount').value);
            const priority = document.getElementById('expensePriority').value;
            const dueDay = parseInt(document.getElementById('expenseDueDay').value, 10);
            const frequency = document.getElementById('expenseFrequency').value;

            if (!name || !amount) {
                alert('Please fill in expense details');
                return;
            }

            expenses.push({
                name: name,
                category: category,
                bucket_type: type,
                monthly_amount: amount,
                currency: 'USD',
                priority: priority,
                is_stable: true,
                due_day: dueDay,
                frequency: frequency
            });

            renderExpenses();

            // Clear form
            document.getElementById('expenseName').value = '';
            document.getElementById('expenseAmount').value = '';
        }

        function removeExpense(index) {
            expenses.splice(index, 1);
            renderExpenses();
        }

        function renderExpenses() {
            const list = document.getElementById('expensesList');

            list.innerHTML = expenses.map((expense, i) => {
                const dueDay = expense.due_day || 15;
                const dueDayLabel = dueDay === 31 ? 'Last day' : `Day ${dueDay}`;
                const freq = expense.frequency || 'monthly';

                return `
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">${expense.name}</span>
                            <button class="btn btn-remove" onclick="removeExpense(${i})">Remove</button>
                        </div>
                        <div>${expense.category} ‚Ä¢ $${expense.monthly_amount.toLocaleString()}/${freq} ‚Ä¢ Priority: ${expense.priority}</div>
                        <div><small style="color: #666;">Due: ${dueDayLabel} of month</small></div>
                    </div>
                `;
            }).join('');

            // Update buffer preview when expenses change
            updateBufferPreview();
        }

        // Cash Buffer Functions
        // Try to load from localStorage first, otherwise use defaults
        let cashBufferConfig = JSON.parse(localStorage.getItem('cashBufferConfig')) || {
            type: 'months',
            months: 3,
            fixedAmount: 0,
            calculatedAmount: 0
        };

        function updateBufferPreview() {
            const bufferType = document.getElementById('bufferType')?.value || 'months';
            const bufferMonthsGroup = document.getElementById('bufferMonthsGroup');
            const bufferFixedGroup = document.getElementById('bufferFixedGroup');

            // Toggle visibility
            if (bufferMonthsGroup && bufferFixedGroup) {
                if (bufferType === 'months') {
                    bufferMonthsGroup.style.display = 'block';
                    bufferFixedGroup.style.display = 'none';
                } else {
                    bufferMonthsGroup.style.display = 'none';
                    bufferFixedGroup.style.display = 'block';
                }
            }

            // Calculate total monthly expenses
            const totalMonthlyExpenses = expenses.reduce((sum, exp) => sum + (exp.monthly_amount || 0), 0);

            let bufferAmount = 0;
            let bufferText = '';

            if (bufferType === 'months') {
                const months = parseInt(document.getElementById('bufferMonths')?.value || 3);
                bufferAmount = totalMonthlyExpenses * months;
                cashBufferConfig = {
                    type: 'months',
                    months: months,
                    fixedAmount: 0,
                    calculatedAmount: bufferAmount
                };
                bufferText = `$${bufferAmount.toLocaleString()} (${months} months √ó $${totalMonthlyExpenses.toLocaleString()}/month expenses)`;
            } else {
                bufferAmount = parseFloat(document.getElementById('bufferFixedAmount')?.value || 0);
                cashBufferConfig = {
                    type: 'fixed',
                    months: 0,
                    fixedAmount: bufferAmount,
                    calculatedAmount: bufferAmount
                };
                const monthsEquivalent = totalMonthlyExpenses > 0 ? (bufferAmount / totalMonthlyExpenses).toFixed(1) : 0;
                bufferText = `$${bufferAmount.toLocaleString()} (‚âà ${monthsEquivalent} months of expenses)`;
            }

            const previewText = document.getElementById('bufferPreviewText');
            if (previewText) {
                if (expenses.length === 0) {
                    previewText.innerHTML = 'Add expenses above to calculate your buffer amount';
                } else {
                    previewText.innerHTML = bufferText;
                }
            }

            // Save to localStorage for persistence
            localStorage.setItem('cashBufferConfig', JSON.stringify(cashBufferConfig));
        }

        // Get current buffer amount (recalculate if needed)
        function getBufferAmount() {
            // If we have a calculated amount, use it
            if (cashBufferConfig.calculatedAmount > 0) {
                return cashBufferConfig.calculatedAmount;
            }

            // Otherwise, recalculate based on current expenses and config
            const totalMonthlyExpenses = expenses.reduce((sum, exp) => sum + (exp.monthly_amount || 0), 0);

            if (cashBufferConfig.type === 'months' && cashBufferConfig.months > 0) {
                cashBufferConfig.calculatedAmount = totalMonthlyExpenses * cashBufferConfig.months;
            } else if (cashBufferConfig.type === 'fixed' && cashBufferConfig.fixedAmount > 0) {
                cashBufferConfig.calculatedAmount = cashBufferConfig.fixedAmount;
            }

            // If still 0, try to get from DOM elements (in case we're in onboarding)
            if (cashBufferConfig.calculatedAmount === 0) {
                const bufferType = document.getElementById('bufferType')?.value || 'months';
                if (bufferType === 'months') {
                    const months = parseInt(document.getElementById('bufferMonths')?.value || 3);
                    cashBufferConfig.calculatedAmount = totalMonthlyExpenses * months;
                } else {
                    cashBufferConfig.calculatedAmount = parseFloat(document.getElementById('bufferFixedAmount')?.value || 0);
                }
            }

            return cashBufferConfig.calculatedAmount;
        }

        // Submit Onboarding
        async function submitOnboarding() {
            // Show loading page
            document.getElementById('page3').classList.remove('active');
            document.getElementById('page4').classList.add('active');
            document.getElementById('loadingSection').classList.remove('hidden');
            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('errorSection').classList.add('hidden');

            try {
                // Submit onboarding data
                const response = await fetch(`${API_BASE}/data/onboarding`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user: userData,
                        cash_position: accounts,
                        clients: clients,
                        expenses: expenses
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Validation error:', errorData);
                    throw new Error(`API error: ${response.statusText} - ${JSON.stringify(errorData.detail || errorData)}`);
                }

                const onboardingResult = await response.json();
                const userId = onboardingResult.user.id;

                // Store user ID globally for scenario analysis
                currentUserId = userId;

                // Get forecast
                const forecastResponse = await fetch(`${API_BASE}/forecast?user_id=${userId}`);

                if (!forecastResponse.ok) {
                    throw new Error(`Forecast API error: ${forecastResponse.statusText}`);
                }

                const forecast = await forecastResponse.json();

                // Display results
                displayForecast(forecast);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('loadingSection').classList.add('hidden');
                document.getElementById('errorSection').classList.remove('hidden');
                document.getElementById('errorMessage').textContent = error.message;
            }
        }

        // Global variables for chart
        let forecastData = null;
        let currentChart = null;
        let currentChartType = 'balance';
        let currentUserId = null;

        function displayForecast(forecast) {
            document.getElementById('loadingSection').classList.add('hidden');
            document.getElementById('resultSection').classList.remove('hidden');

            // Store forecast data globally
            forecastData = forecast;

            // Summary
            const summary = forecast.summary;
            document.getElementById('forecastSummary').innerHTML = `
                <div class="forecast-summary">
                    <h3 style="margin-bottom: 15px;">Summary</h3>
                    <div class="summary-stat">
                        <strong>Starting Cash:</strong> $${parseFloat(forecast.starting_cash).toLocaleString()}
                    </div>
                    <div class="summary-stat">
                        <strong>Total Cash In:</strong> $${parseFloat(summary.total_cash_in).toLocaleString()}
                    </div>
                    <div class="summary-stat">
                        <strong>Total Cash Out:</strong> $${parseFloat(summary.total_cash_out).toLocaleString()}
                    </div>
                    <div class="summary-stat">
                        <strong>Lowest Cash:</strong> $${parseFloat(summary.lowest_cash_amount).toLocaleString()} (Week ${summary.lowest_cash_week})
                    </div>
                    <div class="summary-stat">
                        <strong>Runway:</strong> ${summary.runway_weeks} weeks
                    </div>
                    <div class="summary-stat" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                        <strong style="color: #dc3545;">üõ°Ô∏è Cash Buffer:</strong> $${cashBufferConfig.calculatedAmount.toLocaleString()}
                        ${parseFloat(summary.lowest_cash_amount) < cashBufferConfig.calculatedAmount
                            ? '<span style="color: #dc3545; font-weight: bold;"> ‚ö†Ô∏è AT RISK</span>'
                            : '<span style="color: #28a745; font-weight: bold;"> ‚úì SAFE</span>'
                        }
                    </div>
                </div>
            `;

            // Create chart
            createChart('balance');

            // Weeks with expand/collapse
            const weeksHtml = forecast.weeks.map((week, index) => {
                const endingBalance = parseFloat(week.ending_balance);
                const isNegative = endingBalance < 0;

                const eventsHtml = week.events.length > 0 ? `
                    <div class="week-details" id="week-${index}-details">
                        <strong>Events:</strong>
                        ${week.events.map(event => `
                            <div class="event-item event-${event.direction}">
                                <strong>${event.direction === 'in' ? '‚ÜóÔ∏è In' : '‚ÜòÔ∏è Out'}:</strong>
                                $${parseFloat(event.amount).toLocaleString()} -
                                ${event.category || event.event_type}
                                (${event.confidence} confidence)
                            </div>
                        `).join('')}
                    </div>
                ` : '<div class="week-details" id="week-${index}-details"><em>No events this week</em></div>';

                return `
                    <div class="forecast-week ${isNegative ? 'negative' : ''}" onclick="toggleWeekDetails(${index})">
                        <strong>Week ${week.week_number}</strong> (${week.week_start} to ${week.week_end})
                        <div style="margin-top: 8px;">
                            Starting: $${parseFloat(week.starting_balance).toLocaleString()} |
                            In: $${parseFloat(week.cash_in).toLocaleString()} |
                            Out: $${parseFloat(week.cash_out).toLocaleString()} |
                            <strong>Ending: $${endingBalance.toLocaleString()}</strong>
                        </div>
                        ${eventsHtml}
                    </div>
                `;
            }).join('');

            document.getElementById('forecastWeeks').innerHTML = weeksHtml;

            // Load managed data for the manage section
            loadManagedData();

            // Initialize the manage client billing config
            updateManageBillingConfig();
        }

        function toggleWeekDetails(weekIndex) {
            const details = document.getElementById(`week-${weekIndex}-details`);
            details.classList.toggle('expanded');
        }

        function createChart(type) {
            currentChartType = type;

            const ctx = document.getElementById('forecastChart').getContext('2d');

            // Destroy previous chart if exists
            if (currentChart) {
                currentChart.destroy();
            }

            const weeks = forecastData.weeks;
            const labels = weeks.map(w => `Week ${w.week_number}`);

            let datasets = [];

            if (type === 'balance') {
                // Cash Balance Line Chart with Buffer Line
                const balanceData = weeks.map(w => parseFloat(w.ending_balance));
                const bufferAmount = getBufferAmount();

                // Check for buffer breaches
                const breachWeeks = [];
                balanceData.forEach((balance, index) => {
                    if (balance < bufferAmount) {
                        breachWeeks.push(index + 1);
                    }
                });

                // Color points based on buffer status
                const pointColors = balanceData.map(balance =>
                    balance < bufferAmount ? '#dc3545' : '#667eea'
                );
                const pointBorderColors = balanceData.map(balance =>
                    balance < bufferAmount ? '#dc3545' : '#667eea'
                );

                datasets = [
                    {
                        label: 'Ending Balance',
                        data: balanceData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointBackgroundColor: pointColors,
                        pointBorderColor: pointBorderColors,
                        pointBorderWidth: 2
                    },
                    // Buffer line - only show if buffer > 0
                    ...(bufferAmount > 0 ? [{
                        label: 'Cash Buffer (Minimum)',
                        data: Array(weeks.length).fill(bufferAmount),
                        borderColor: '#dc3545',
                        backgroundColor: 'transparent',
                        borderWidth: 3,
                        borderDash: [10, 5],
                        fill: false,
                        tension: 0,
                        pointRadius: 0,
                        pointHoverRadius: 0,
                        order: 0
                    }] : [])
                ];

                currentChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 20
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: (context) => {
                                        const value = context.parsed.y;
                                        // Check by label instead of index since buffer may or may not exist
                                        if (context.dataset.label === 'Cash Buffer (Minimum)') {
                                            return `Buffer: $${value.toLocaleString()}`;
                                        }
                                        const status = bufferAmount > 0 && value < bufferAmount ? ' ‚ö†Ô∏è BELOW BUFFER' : '';
                                        return `Balance: $${value.toLocaleString()}${status}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: (value) => '$' + value.toLocaleString()
                                }
                            }
                        }
                    }
                });

                // Show buffer breach warning
                showBufferWarning(breachWeeks, bufferAmount);
            } else {
                // Cash Flow Bar Chart
                datasets = [
                    {
                        label: 'Cash In',
                        data: weeks.map(w => parseFloat(w.cash_in)),
                        backgroundColor: 'rgba(76, 175, 80, 0.8)',
                    },
                    {
                        label: 'Cash Out',
                        data: weeks.map(w => parseFloat(w.cash_out)),
                        backgroundColor: 'rgba(244, 67, 54, 0.8)',
                    }
                ];

                currentChart = new Chart(ctx, {
                    type: 'bar',
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: (context) => `${context.dataset.label}: $${context.parsed.y.toLocaleString()}`
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: (value) => '$' + value.toLocaleString()
                                }
                            }
                        }
                    }
                });
            }
        }

        function showBufferWarning(breachWeeks, bufferAmount) {
            // Remove existing warning
            const existingWarning = document.getElementById('bufferWarning');
            if (existingWarning) {
                existingWarning.remove();
            }

            // Create warning element
            const warningDiv = document.createElement('div');
            warningDiv.id = 'bufferWarning';

            if (breachWeeks.length > 0) {
                const firstBreach = breachWeeks[0];
                const weeksUntilBreach = firstBreach;

                warningDiv.innerHTML = `
                    <div style="background: #fff3f3; border: 2px solid #dc3545; border-radius: 8px; padding: 20px; margin: 20px 0;">
                        <h3 style="color: #dc3545; margin: 0 0 10px 0;">‚ö†Ô∏è Cash Buffer Warning</h3>
                        <p style="margin: 0 0 10px 0;">
                            Your forecast shows you'll fall below your minimum cash buffer of <strong>$${bufferAmount.toLocaleString()}</strong>
                            in <strong>Week ${firstBreach}</strong> (${weeksUntilBreach === 1 ? 'next week' : `${weeksUntilBreach} weeks from now`}).
                        </p>
                        <p style="margin: 0 0 10px 0; color: #666;">
                            <strong>Affected weeks:</strong> ${breachWeeks.map(w => `Week ${w}`).join(', ')}
                        </p>
                        <p style="margin: 0; font-size: 14px; color: #666;">
                            üí° <em>Consider using Scenario Analysis below to explore options like accelerating receivables, delaying expenses, or finding new revenue.</em>
                        </p>
                    </div>
                `;
            } else {
                warningDiv.innerHTML = `
                    <div style="background: #f0fff0; border: 2px solid #28a745; border-radius: 8px; padding: 20px; margin: 20px 0;">
                        <h3 style="color: #28a745; margin: 0 0 10px 0;">‚úÖ Cash Buffer Status: Safe</h3>
                        <p style="margin: 0;">
                            Your forecast shows you'll stay above your minimum cash buffer of <strong>$${bufferAmount.toLocaleString()}</strong>
                            throughout the 13-week period.
                        </p>
                    </div>
                `;
            }

            // Insert after chart
            const chartContainer = document.querySelector('.chart-container');
            if (chartContainer) {
                chartContainer.parentNode.insertBefore(warningDiv, chartContainer.nextSibling);
            }
        }

        function showChart(type) {
            // Update tab styling
            document.querySelectorAll('.chart-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');

            // Create new chart
            createChart(type);
        }

        function exportCSV() {
            if (!forecastData) return;

            let csv = 'Week,Start Date,End Date,Starting Balance,Cash In,Cash Out,Net Change,Ending Balance\n';

            forecastData.weeks.forEach(week => {
                csv += `${week.week_number},${week.week_start},${week.week_end},${week.starting_balance},${week.cash_in},${week.cash_out},${week.net_change},${week.ending_balance}\n`;
            });

            downloadFile(csv, 'tamio-forecast.csv', 'text/csv');
        }

        function exportJSON() {
            if (!forecastData) return;

            const json = JSON.stringify(forecastData, null, 2);
            downloadFile(json, 'tamio-forecast.json', 'application/json');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function startOver() {
            location.reload();
        }

        // ============================================================================
        // MANAGE DATA FUNCTIONS
        // ============================================================================

        let managedClients = [];
        let managedExpenses = [];

        function showDataTab(tab) {
            document.getElementById('clientsTab').classList.remove('active');
            document.getElementById('expensesTab').classList.remove('active');
            document.getElementById('integrationsTab').classList.remove('active');
            document.getElementById('manageClientsSection').style.display = 'none';
            document.getElementById('manageExpensesSection').style.display = 'none';
            document.getElementById('manageIntegrationsSection').style.display = 'none';

            if (tab === 'clients') {
                document.getElementById('clientsTab').classList.add('active');
                document.getElementById('manageClientsSection').style.display = 'block';
            } else if (tab === 'expenses') {
                document.getElementById('expensesTab').classList.add('active');
                document.getElementById('manageExpensesSection').style.display = 'block';
            } else if (tab === 'integrations') {
                document.getElementById('integrationsTab').classList.add('active');
                document.getElementById('manageIntegrationsSection').style.display = 'block';
                checkXeroStatus();
            }
        }

        async function loadManagedData() {
            if (!currentUserId) return;

            try {
                // Load clients
                const clientsRes = await fetch(`${API_BASE}/data/clients?user_id=${currentUserId}`);
                if (clientsRes.ok) {
                    managedClients = await clientsRes.json();
                    renderManagedClients();
                }

                // Load expenses
                const expensesRes = await fetch(`${API_BASE}/data/expenses?user_id=${currentUserId}`);
                if (expensesRes.ok) {
                    managedExpenses = await expensesRes.json();
                    renderManagedExpenses();
                }
            } catch (error) {
                console.error('Error loading managed data:', error);
            }
        }

        function renderManagedClients() {
            const list = document.getElementById('manageClientsList');

            if (managedClients.length === 0) {
                list.innerHTML = '<p style="color: #666; text-align: center;">No clients yet. Add your first client below.</p>';
                return;
            }

            list.innerHTML = managedClients.map((client, i) => {
                let details = `Type: ${client.client_type} ‚Ä¢ ${client.currency}`;

                if (client.client_type === 'retainer' && client.billing_config) {
                    const invoiceDay = client.billing_config.invoice_day || 1;
                    const terms = client.billing_config.payment_terms || 'net_30';
                    const termsNum = parseInt(terms.replace('net_', ''));
                    const expectedDay = Math.min(invoiceDay + termsNum, 28);
                    details += `<br>$${client.billing_config.amount?.toLocaleString() || 0}/${client.billing_config.frequency}`;
                    details += `<br><small style="color: #666;">Invoice: Day ${invoiceDay} ‚Üí Payment: ~Day ${expectedDay}</small>`;
                }

                return `
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">${client.name}</span>
                            <div>
                                <button class="btn btn-secondary" onclick="editManagedClient('${client.id}')" style="margin-right: 5px; padding: 5px 10px; font-size: 12px;">Edit</button>
                                <button class="btn btn-remove" onclick="deleteManagedClient('${client.id}')">Delete</button>
                            </div>
                        </div>
                        <div>${details}</div>
                    </div>
                `;
            }).join('');
        }

        function renderManagedExpenses() {
            const list = document.getElementById('manageExpensesList');

            if (managedExpenses.length === 0) {
                list.innerHTML = '<p style="color: #666; text-align: center;">No expenses yet. Add your first expense below.</p>';
                return;
            }

            list.innerHTML = managedExpenses.map((expense, i) => {
                const dueDay = expense.due_day || 15;
                const dueDayLabel = dueDay === 31 ? 'Last day' : `Day ${dueDay}`;
                const freq = expense.frequency || 'monthly';

                return `
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">${expense.name}</span>
                            <div>
                                <button class="btn btn-secondary" onclick="editManagedExpense('${expense.id}')" style="margin-right: 5px; padding: 5px 10px; font-size: 12px;">Edit</button>
                                <button class="btn btn-remove" onclick="deleteManagedExpense('${expense.id}')">Delete</button>
                            </div>
                        </div>
                        <div>${expense.category} ‚Ä¢ $${expense.monthly_amount?.toLocaleString() || 0}/${freq} ‚Ä¢ Priority: ${expense.priority}</div>
                        <div><small style="color: #666;">Due: ${dueDayLabel} of month</small></div>
                    </div>
                `;
            }).join('');
        }

        function updateManageBillingConfig() {
            const type = document.getElementById('manageClientType').value;
            const section = document.getElementById('manageBillingConfigSection');

            let html = '';

            if (type === 'retainer') {
                html = `
                    <div class="row">
                        <div class="form-group">
                            <label>Billing Frequency</label>
                            <select id="manageBillingFrequency">
                                <option value="monthly">Monthly</option>
                                <option value="quarterly">Quarterly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Amount</label>
                            <input type="number" id="manageBillingAmount" placeholder="10000" step="0.01">
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-group">
                            <label>Invoice Day of Month</label>
                            <select id="manageInvoiceDay">
                                <option value="1">1st</option>
                                <option value="15">15th</option>
                                <option value="28">28th</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Payment Terms</label>
                            <select id="managePaymentTerms">
                                <option value="net_7">Net 7</option>
                                <option value="net_14">Net 14</option>
                                <option value="net_30" selected>Net 30</option>
                                <option value="net_45">Net 45</option>
                                <option value="net_60">Net 60</option>
                            </select>
                        </div>
                    </div>
                `;
            } else if (type === 'project') {
                html = `
                    <div class="row">
                        <div class="form-group">
                            <label>Total Project Value</label>
                            <input type="number" id="manageProjectValue" placeholder="50000" step="0.01">
                        </div>
                        <div class="form-group">
                            <label>Deposit Amount</label>
                            <input type="number" id="manageDepositAmount" placeholder="15000" step="0.01">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Expected Deposit Date</label>
                        <input type="date" id="manageDepositDate">
                    </div>
                `;
            } else if (type === 'usage') {
                html = `
                    <div class="row">
                        <div class="form-group">
                            <label>Settlement Frequency</label>
                            <select id="manageSettlementFrequency">
                                <option value="weekly">Weekly</option>
                                <option value="monthly">Monthly</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Typical Amount</label>
                            <input type="number" id="manageTypicalAmount" placeholder="5000" step="0.01">
                        </div>
                    </div>
                `;
            }

            section.innerHTML = html;
        }

        async function addManagedClient() {
            const name = document.getElementById('manageClientName').value;
            const type = document.getElementById('manageClientType').value;
            const currency = document.getElementById('manageClientCurrency').value;

            if (!name) {
                alert('Please enter client name');
                return;
            }

            let billingConfig = {};

            if (type === 'retainer') {
                const amount = parseFloat(document.getElementById('manageBillingAmount').value);
                if (!amount) {
                    alert('Please enter billing amount');
                    return;
                }
                billingConfig = {
                    frequency: document.getElementById('manageBillingFrequency').value,
                    invoice_day: parseInt(document.getElementById('manageInvoiceDay').value),
                    amount: amount,
                    payment_terms: document.getElementById('managePaymentTerms').value
                };
            } else if (type === 'project') {
                const totalValue = parseFloat(document.getElementById('manageProjectValue').value);
                const depositAmount = parseFloat(document.getElementById('manageDepositAmount').value);
                const depositDate = document.getElementById('manageDepositDate').value;

                if (!totalValue || !depositAmount || !depositDate) {
                    alert('Please fill in project details');
                    return;
                }

                billingConfig = {
                    total_value: totalValue,
                    payment_structure: "milestone",
                    milestones: [{
                        name: "Deposit",
                        amount: depositAmount,
                        expected_date: depositDate,
                        trigger_type: "date",
                        payment_terms: "net_7"
                    }]
                };
            } else if (type === 'usage') {
                const amount = parseFloat(document.getElementById('manageTypicalAmount').value);
                if (!amount) {
                    alert('Please enter typical amount');
                    return;
                }
                billingConfig = {
                    settlement_frequency: document.getElementById('manageSettlementFrequency').value,
                    typical_amount: amount,
                    payment_terms: "net_30"
                };
            }

            try {
                const response = await fetch(`${API_BASE}/data/clients`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: currentUserId,
                        name: name,
                        client_type: type,
                        currency: currency,
                        status: "active",
                        payment_behavior: "on_time",
                        churn_risk: "low",
                        scope_risk: "low",
                        billing_config: billingConfig
                    })
                });

                if (response.ok) {
                    document.getElementById('manageClientName').value = '';
                    await loadManagedData();
                    alert('Client added successfully!');
                } else {
                    alert('Error adding client');
                }
            } catch (error) {
                console.error('Error adding client:', error);
                alert('Error adding client');
            }
        }

        async function deleteManagedClient(clientId) {
            if (!confirm('Are you sure you want to delete this client? This will also remove their future cash events.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/data/clients/${clientId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadManagedData();
                    alert('Client deleted successfully!');
                } else {
                    alert('Error deleting client');
                }
            } catch (error) {
                console.error('Error deleting client:', error);
                alert('Error deleting client');
            }
        }

        function editManagedClient(clientId) {
            alert('Edit functionality coming soon! For now, delete and re-add the client.');
        }

        async function addManagedExpense() {
            const name = document.getElementById('manageExpenseName').value;
            const category = document.getElementById('manageExpenseCategory').value;
            const type = document.getElementById('manageExpenseType').value;
            const amount = parseFloat(document.getElementById('manageExpenseAmount').value);
            const priority = document.getElementById('manageExpensePriority').value;
            const dueDay = parseInt(document.getElementById('manageExpenseDueDay').value, 10);
            const frequency = document.getElementById('manageExpenseFrequency').value;

            if (!name || !amount) {
                alert('Please fill in expense details');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/data/expenses`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: currentUserId,
                        name: name,
                        category: category,
                        bucket_type: type,
                        monthly_amount: amount,
                        currency: 'USD',
                        priority: priority,
                        is_stable: true,
                        due_day: dueDay,
                        frequency: frequency
                    })
                });

                if (response.ok) {
                    document.getElementById('manageExpenseName').value = '';
                    document.getElementById('manageExpenseAmount').value = '';
                    await loadManagedData();
                    alert('Expense added successfully!');
                } else {
                    alert('Error adding expense');
                }
            } catch (error) {
                console.error('Error adding expense:', error);
                alert('Error adding expense');
            }
        }

        async function deleteManagedExpense(expenseId) {
            if (!confirm('Are you sure you want to delete this expense? This will also remove its future cash events.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/data/expenses/${expenseId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadManagedData();
                    alert('Expense deleted successfully!');
                } else {
                    alert('Error deleting expense');
                }
            } catch (error) {
                console.error('Error deleting expense:', error);
                alert('Error deleting expense');
            }
        }

        function editManagedExpense(expenseId) {
            alert('Edit functionality coming soon! For now, delete and re-add the expense.');
        }

        async function regenerateForecast() {
            if (!currentUserId) {
                alert('No user ID available');
                return;
            }

            try {
                // Show loading
                document.getElementById('forecastSummary').innerHTML = '<p>Regenerating forecast...</p>';

                // Regenerate events for all clients and expenses
                const regenResponse = await fetch(`${API_BASE}/data/regenerate-events?user_id=${currentUserId}`, {
                    method: 'POST'
                });

                // Get new forecast
                const forecastResponse = await fetch(`${API_BASE}/forecast?user_id=${currentUserId}`);

                if (forecastResponse.ok) {
                    const forecast = await forecastResponse.json();
                    displayForecast(forecast);
                    alert('Forecast regenerated successfully!');
                } else {
                    alert('Error regenerating forecast');
                }
            } catch (error) {
                console.error('Error regenerating forecast:', error);
                alert('Error regenerating forecast');
            }
        }

        // ============================================================================
        // XERO INTEGRATION FUNCTIONS
        // ============================================================================

        async function checkXeroStatus() {
            if (!currentUserId) return;

            const statusDiv = document.getElementById('xeroStatus');
            const statusText = document.getElementById('xeroStatusText');
            const notConnected = document.getElementById('xeroNotConnected');
            const connected = document.getElementById('xeroConnected');

            try {
                const response = await fetch(`${API_BASE}/xero/status?user_id=${currentUserId}`);
                const data = await response.json();

                if (data.is_connected) {
                    statusDiv.style.background = '#d4edda';
                    statusText.innerHTML = `<strong style="color: #155724;">‚úì Connected to Xero</strong><br>
                        <small>Tenant: ${data.tenant_name || 'Unknown'}</small><br>
                        <small>Last sync: ${data.last_sync_at ? new Date(data.last_sync_at).toLocaleString() : 'Never'}</small>`;
                    notConnected.style.display = 'none';
                    connected.style.display = 'block';
                } else {
                    statusDiv.style.background = '#e9ecef';
                    statusText.innerHTML = '<span style="color: #666;">Not connected</span>';
                    notConnected.style.display = 'block';
                    connected.style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking Xero status:', error);
                statusDiv.style.background = '#f8d7da';
                statusText.innerHTML = '<span style="color: #721c24;">Error checking connection status</span>';
            }
        }

        async function connectXero() {
            if (!currentUserId) {
                alert('Please complete onboarding first');
                return;
            }

            try {
                // Get the authorization URL from the backend
                const response = await fetch(`${API_BASE}/xero/connect?user_id=${currentUserId}`);
                const data = await response.json();

                if (data.authorization_url) {
                    // Store user ID in session storage for callback
                    sessionStorage.setItem('xero_user_id', currentUserId);
                    // Redirect to Xero OAuth
                    window.location.href = data.authorization_url;
                } else {
                    alert('Error getting authorization URL: ' + (data.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Error connecting to Xero:', error);
                alert('Error connecting to Xero. Please try again.');
            }
        }

        async function previewXeroData() {
            if (!currentUserId) return;

            const previewArea = document.getElementById('xeroPreviewArea');
            const previewContent = document.getElementById('xeroPreviewContent');

            previewArea.style.display = 'block';
            previewContent.innerHTML = '<p>Loading preview...</p>';

            try {
                const response = await fetch(`${API_BASE}/xero/preview?user_id=${currentUserId}`);

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to fetch preview');
                }

                const data = await response.json();

                let html = '<div style="max-height: 400px; overflow-y: auto;">';

                // Contacts section
                if (data.contacts && data.contacts.length > 0) {
                    html += `<h5 style="margin-top: 15px; color: #333;">üë• Contacts (${data.contacts.length})</h5>`;
                    html += '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';
                    html += '<tr style="background: #f5f5f5;"><th style="padding: 8px; text-align: left;">Name</th><th style="padding: 8px; text-align: left;">Email</th><th style="padding: 8px; text-align: right;">Balance</th></tr>';
                    data.contacts.slice(0, 10).forEach(c => {
                        html += `<tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 8px;">${c.name || 'N/A'}</td>
                            <td style="padding: 8px;">${c.email || '-'}</td>
                            <td style="padding: 8px; text-align: right;">$${(c.balance || 0).toLocaleString()}</td>
                        </tr>`;
                    });
                    if (data.contacts.length > 10) {
                        html += `<tr><td colspan="3" style="padding: 8px; color: #666; text-align: center;">...and ${data.contacts.length - 10} more</td></tr>`;
                    }
                    html += '</table>';
                }

                // Invoices section
                if (data.invoices && data.invoices.length > 0) {
                    html += `<h5 style="margin-top: 20px; color: #333;">üìÑ Recent Invoices (${data.invoices.length})</h5>`;
                    html += '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';
                    html += '<tr style="background: #f5f5f5;"><th style="padding: 8px; text-align: left;">Invoice #</th><th style="padding: 8px; text-align: left;">Contact</th><th style="padding: 8px; text-align: right;">Amount</th><th style="padding: 8px; text-align: left;">Status</th></tr>';
                    data.invoices.slice(0, 10).forEach(inv => {
                        const statusColor = inv.status === 'PAID' ? '#4caf50' : inv.status === 'AUTHORISED' ? '#ff9800' : '#666';
                        html += `<tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 8px;">${inv.invoice_number || 'N/A'}</td>
                            <td style="padding: 8px;">${inv.contact_name || 'N/A'}</td>
                            <td style="padding: 8px; text-align: right;">$${(inv.total || 0).toLocaleString()}</td>
                            <td style="padding: 8px; color: ${statusColor};">${inv.status || 'N/A'}</td>
                        </tr>`;
                    });
                    if (data.invoices.length > 10) {
                        html += `<tr><td colspan="4" style="padding: 8px; color: #666; text-align: center;">...and ${data.invoices.length - 10} more</td></tr>`;
                    }
                    html += '</table>';
                }

                // Bills section
                if (data.bills && data.bills.length > 0) {
                    html += `<h5 style="margin-top: 20px; color: #333;">üìã Recent Bills (${data.bills.length})</h5>`;
                    html += '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';
                    html += '<tr style="background: #f5f5f5;"><th style="padding: 8px; text-align: left;">Bill #</th><th style="padding: 8px; text-align: left;">Contact</th><th style="padding: 8px; text-align: right;">Amount</th><th style="padding: 8px; text-align: left;">Status</th></tr>';
                    data.bills.slice(0, 10).forEach(bill => {
                        const statusColor = bill.status === 'PAID' ? '#4caf50' : bill.status === 'AUTHORISED' ? '#ff9800' : '#666';
                        html += `<tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 8px;">${bill.invoice_number || 'N/A'}</td>
                            <td style="padding: 8px;">${bill.contact_name || 'N/A'}</td>
                            <td style="padding: 8px; text-align: right;">$${(bill.total || 0).toLocaleString()}</td>
                            <td style="padding: 8px; color: ${statusColor};">${bill.status || 'N/A'}</td>
                        </tr>`;
                    });
                    if (data.bills.length > 10) {
                        html += `<tr><td colspan="4" style="padding: 8px; color: #666; text-align: center;">...and ${data.bills.length - 10} more</td></tr>`;
                    }
                    html += '</table>';
                }

                // Repeating invoices section
                if (data.repeating_invoices && data.repeating_invoices.length > 0) {
                    html += `<h5 style="margin-top: 20px; color: #333;">üîÑ Repeating Invoices (${data.repeating_invoices.length})</h5>`;
                    html += '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';
                    html += '<tr style="background: #f5f5f5;"><th style="padding: 8px; text-align: left;">Contact</th><th style="padding: 8px; text-align: right;">Amount</th><th style="padding: 8px; text-align: left;">Schedule</th></tr>';
                    data.repeating_invoices.forEach(ri => {
                        html += `<tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 8px;">${ri.contact_name || 'N/A'}</td>
                            <td style="padding: 8px; text-align: right;">$${(ri.total || 0).toLocaleString()}</td>
                            <td style="padding: 8px;">${ri.schedule_unit || 'N/A'} (${ri.schedule_period || 1})</td>
                        </tr>`;
                    });
                    html += '</table>';
                }

                if (!data.contacts?.length && !data.invoices?.length && !data.bills?.length && !data.repeating_invoices?.length) {
                    html += '<p style="color: #666; text-align: center;">No data found in Xero</p>';
                }

                html += '</div>';
                previewContent.innerHTML = html;

            } catch (error) {
                console.error('Error fetching preview:', error);
                previewContent.innerHTML = `<p style="color: #dc3545;">Error loading preview: ${error.message}</p>`;
            }
        }

        function hideXeroPreview() {
            document.getElementById('xeroPreviewArea').style.display = 'none';
        }

        async function syncXeroData() {
            if (!currentUserId) return;

            const confirmed = confirm('This will import data from Xero and may update existing clients and events. Continue?');
            if (!confirmed) return;

            hideXeroPreview();

            // Show syncing status
            const statusDiv = document.getElementById('xeroStatus');
            const statusText = document.getElementById('xeroStatusText');
            statusDiv.style.background = '#fff3cd';
            statusText.innerHTML = '<strong style="color: #856404;">‚è≥ Syncing with Xero...</strong>';

            try {
                const response = await fetch(`${API_BASE}/xero/sync`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        user_id: currentUserId,
                        sync_type: 'full'
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Sync failed');
                }

                const data = await response.json();

                // Show success
                statusDiv.style.background = '#d4edda';
                statusText.innerHTML = `<strong style="color: #155724;">‚úì Sync Complete!</strong><br>
                    <small>Created: ${data.records_created?.clients || 0} clients, ${data.records_created?.events || 0} events</small><br>
                    <small>Updated: ${data.records_updated?.clients || 0} clients, ${data.records_updated?.events || 0} events</small>`;

                // Reload managed data to reflect changes
                await loadManagedData();

                // Refresh the status
                setTimeout(() => checkXeroStatus(), 2000);

            } catch (error) {
                console.error('Error syncing:', error);
                statusDiv.style.background = '#f8d7da';
                statusText.innerHTML = `<strong style="color: #721c24;">‚úó Sync Failed</strong><br><small>${error.message}</small>`;
            }
        }

        async function viewXeroSyncHistory() {
            if (!currentUserId) return;

            const historyArea = document.getElementById('xeroHistoryArea');
            const historyContent = document.getElementById('xeroHistoryContent');

            historyArea.style.display = 'block';
            historyContent.innerHTML = '<p>Loading sync history...</p>';

            try {
                const response = await fetch(`${API_BASE}/xero/sync-history?user_id=${currentUserId}`);

                if (!response.ok) {
                    throw new Error('Failed to load history');
                }

                const logs = await response.json();

                if (logs.length === 0) {
                    historyContent.innerHTML = '<p style="color: #666; text-align: center;">No sync history yet</p>';
                    return;
                }

                let html = '<table style="width: 100%; border-collapse: collapse; font-size: 14px;">';
                html += '<tr style="background: #f5f5f5;"><th style="padding: 8px; text-align: left;">Date</th><th style="padding: 8px; text-align: left;">Status</th><th style="padding: 8px; text-align: left;">Details</th></tr>';

                logs.forEach(log => {
                    const statusColor = log.status === 'completed' ? '#4caf50' : log.status === 'failed' ? '#dc3545' : '#ff9800';
                    const date = new Date(log.started_at).toLocaleString();
                    let details = '';

                    if (log.records_created) {
                        details += `Created: ${log.records_created.clients || 0} clients, ${log.records_created.events || 0} events. `;
                    }
                    if (log.records_updated) {
                        details += `Updated: ${log.records_updated.clients || 0} clients, ${log.records_updated.events || 0} events.`;
                    }
                    if (log.error_message) {
                        details = log.error_message;
                    }

                    html += `<tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 8px;">${date}</td>
                        <td style="padding: 8px; color: ${statusColor}; font-weight: bold;">${log.status}</td>
                        <td style="padding: 8px;">${details || '-'}</td>
                    </tr>`;
                });

                html += '</table>';
                historyContent.innerHTML = html;

            } catch (error) {
                console.error('Error loading history:', error);
                historyContent.innerHTML = `<p style="color: #dc3545;">Error loading history: ${error.message}</p>`;
            }
        }

        function hideXeroHistory() {
            document.getElementById('xeroHistoryArea').style.display = 'none';
        }

        async function disconnectXero() {
            if (!currentUserId) return;

            const confirmed = confirm('Are you sure you want to disconnect Xero? This will not delete imported data.');
            if (!confirmed) return;

            try {
                const response = await fetch(`${API_BASE}/xero/disconnect?user_id=${currentUserId}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Disconnect failed');
                }

                // Refresh status
                checkXeroStatus();

            } catch (error) {
                console.error('Error disconnecting:', error);
                alert('Error disconnecting from Xero: ' + error.message);
            }
        }

        // Handle OAuth callback (check URL params on page load)
        function handleXeroCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const xeroConnected = urlParams.get('xero_connected');
            const xeroError = urlParams.get('xero_error');

            if (xeroConnected === 'true') {
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
                // Restore user ID if stored
                const storedUserId = sessionStorage.getItem('xero_user_id');
                if (storedUserId) {
                    currentUserId = storedUserId;
                    sessionStorage.removeItem('xero_user_id');
                }
                // Show success and go to integrations
                alert('Successfully connected to Xero!');
                showPage(8); // Go to dashboard
                showDataTab('integrations');
            } else if (xeroError) {
                // Clean URL
                window.history.replaceState({}, document.title, window.location.pathname);
                alert('Error connecting to Xero: ' + xeroError);
            }
        }

        // ============================================================================
        // SCENARIO ANALYSIS FUNCTIONS
        // ============================================================================

        let scenarios = [];

        function showScenarioBuilder() {
            document.getElementById('scenarioBuilder').classList.remove('hidden');
        }

        function hideScenarioBuilder() {
            document.getElementById('scenarioBuilder').classList.add('hidden');
            document.getElementById('scenarioName').value = '';
            document.getElementById('scenarioType').value = '';
            document.getElementById('scenarioParameters').innerHTML = '';
        }

        async function updateScenarioFields() {
            const type = document.getElementById('scenarioType').value;
            const paramsDiv = document.getElementById('scenarioParameters');

            if (!type) {
                paramsDiv.innerHTML = '';
                return;
            }

            // Fetch actual clients from database for client-based scenarios
            let dbClients = clients; // Default to local array
            if (['client_loss', 'payment_delay', 'client_change'].includes(type)) {
                try {
                    const response = await fetch(`${API_BASE}/data/clients?user_id=${currentUserId}`);
                    if (response.ok) {
                        dbClients = await response.json();
                    }
                } catch (error) {
                    console.error('Error fetching clients:', error);
                }
            }

            let html = '';

            if (type === 'hiring') {
                html = `
                    <div class="form-group">
                        <label>Role Title</label>
                        <input type="text" id="roleTitle" placeholder="e.g., Senior Engineer">
                    </div>
                    <div class="row">
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" id="startDate">
                        </div>
                        <div class="form-group">
                            <label>Monthly Cost ($)</label>
                            <input type="number" id="monthlyCost" placeholder="8000" step="100">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Onboarding Costs (optional)</label>
                        <input type="number" id="onboardingCosts" placeholder="2000" step="100">
                    </div>
                `;
            } else if (type === 'client_gain') {
                html = `
                    <div class="form-group">
                        <label>Client Name</label>
                        <input type="text" id="clientName" placeholder="e.g., New Corp">
                    </div>
                    <div class="row">
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" id="startDate">
                        </div>
                        <div class="form-group">
                            <label>Monthly Amount ($)</label>
                            <input type="number" id="monthlyAmount" placeholder="10000" step="100">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Frequency</label>
                        <select id="frequency">
                            <option value="monthly">Monthly</option>
                            <option value="weekly">Weekly</option>
                        </select>
                    </div>
                `;
            } else if (type === 'client_loss') {
                html = `
                    <div class="form-group">
                        <label>Which Client?</label>
                        <select id="clientId">
                            ${dbClients.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Effective Date</label>
                        <input type="date" id="effectiveDate">
                    </div>
                `;
            } else if (type === 'payment_delay') {
                html = `
                    <div class="form-group">
                        <label>Delay (weeks)</label>
                        <input type="number" id="delayWeeks" placeholder="2" min="1" max="12">
                    </div>
                    <div class="form-group">
                        <label>Which Client?</label>
                        <select id="clientId">
                            ${dbClients.map(c => `<option value="${c.id}">${c.name}</option>`).join('')}
                        </select>
                    </div>
                `;
            } else if (type === 'increased_expense' || type === 'decreased_expense') {
                const action = type === 'increased_expense' ? 'New/Increased' : 'Reduced';
                html = `
                    <div class="form-group">
                        <label>Expense Name</label>
                        <input type="text" id="expenseName" placeholder="e.g., Office Rent">
                    </div>
                    <div class="row">
                        <div class="form-group">
                            <label>Monthly Amount ($)</label>
                            <input type="number" id="monthlyAmount" placeholder="3000" step="100">
                        </div>
                        <div class="form-group">
                            <label>Effective Date</label>
                            <input type="date" id="effectiveDate">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Is Recurring?</label>
                        <select id="isRecurring">
                            <option value="true">Yes (Monthly)</option>
                            <option value="false">No (One-time)</option>
                        </select>
                    </div>
                `;
            }

            paramsDiv.innerHTML = html;
        }

        async function buildScenario() {
            const name = document.getElementById('scenarioName').value;
            const type = document.getElementById('scenarioType').value;

            if (!name || !type) {
                alert('Please enter scenario name and type');
                return;
            }

            // Collect parameters based on type
            let parameters = {};
            let scopeConfig = {};

            if (type === 'hiring') {
                parameters = {
                    role_title: document.getElementById('roleTitle').value,
                    start_date: document.getElementById('startDate').value,
                    monthly_cost: parseFloat(document.getElementById('monthlyCost').value),
                    onboarding_costs: parseFloat(document.getElementById('onboardingCosts').value) || 0
                };
            } else if (type === 'client_gain') {
                parameters = {
                    client_name: document.getElementById('clientName').value,
                    start_date: document.getElementById('startDate').value,
                    monthly_amount: parseFloat(document.getElementById('monthlyAmount').value),
                    frequency: document.getElementById('frequency').value
                };
            } else if (type === 'client_loss') {
                scopeConfig.client_id = document.getElementById('clientId').value;
                parameters = {
                    effective_date: document.getElementById('effectiveDate').value
                };
            } else if (type === 'payment_delay') {
                scopeConfig.client_id = document.getElementById('clientId').value;
                parameters = {
                    delay_weeks: parseInt(document.getElementById('delayWeeks').value),
                    event_ids: []  // Would need to fetch event IDs
                };
            } else if (type === 'increased_expense' || type === 'decreased_expense') {
                parameters = {
                    expense_name: document.getElementById('expenseName').value,
                    amount: parseFloat(document.getElementById('monthlyAmount').value),
                    effective_date: document.getElementById('effectiveDate').value,
                    is_recurring: document.getElementById('isRecurring').value === 'true',
                    category: 'other'
                };
            }

            try {
                // Check if this is a linked scenario from a suggestion
                const linkedInfo = window.pendingLinkedScenario;
                const parentScenarioId = linkedInfo ? linkedInfo.parentScenarioId : null;

                // Create scenario
                const scenarioResponse = await fetch(`${API_BASE}/scenarios/scenarios`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        user_id: currentUserId,
                        name: name,
                        scenario_type: type,
                        entry_path: linkedInfo ? 'tamio_suggested' : 'user_defined',
                        scope_config: scopeConfig,
                        parameters: parameters,
                        parent_scenario_id: parentScenarioId
                    })
                });

                // Clear the pending linked scenario info
                window.pendingLinkedScenario = null;

                if (!scenarioResponse.ok) {
                    throw new Error('Failed to create scenario');
                }

                const scenario = await scenarioResponse.json();

                // Build scenario layer
                await fetch(`${API_BASE}/scenarios/scenarios/${scenario.id}/build`, {
                    method: 'POST'
                });

                // Get scenario forecast
                const forecastResponse = await fetch(`${API_BASE}/scenarios/scenarios/${scenario.id}/forecast`);
                const forecastData = await forecastResponse.json();

                // Add to scenarios list
                scenarios.push({scenario, forecastData});

                // Display scenario
                displayScenario(scenario, forecastData);

                // Hide builder
                hideScenarioBuilder();

            } catch (error) {
                console.error('Error building scenario:', error);
                alert('Error building scenario: ' + error.message);
                window.pendingLinkedScenario = null;  // Clear on error too
            }
        }

        function displayScenario(scenario, forecastData) {
            const scenariosList = document.getElementById('scenariosList');

            const scenarioCard = document.createElement('div');
            scenarioCard.style.cssText = 'background: white; border: 2px solid #667eea; border-radius: 8px; padding: 20px; margin-bottom: 20px;';
            scenarioCard.id = `scenario-${scenario.id}`;

            // Calculate impact
            const baseEndingBalance = parseFloat(forecastData.base_forecast.weeks[forecastData.base_forecast.weeks.length - 1].ending_balance);
            const scenarioEndingBalance = parseFloat(forecastData.scenario_forecast.weeks[forecastData.scenario_forecast.weeks.length - 1].ending_balance);
            const impact = scenarioEndingBalance - baseEndingBalance;
            const impactColor = impact >= 0 ? '#4caf50' : '#f44336';

            // Build decision signals
            let signalsHtml = '';
            if (forecastData.decision_signals && forecastData.decision_signals.signals) {
                signalsHtml = forecastData.decision_signals.signals.map(signal => `
                    <div style="background: ${signal.severity === 'red' ? '#ffebee' : '#fff3e0'}; border-left: 4px solid ${signal.severity === 'red' ? '#f44336' : '#ff9800'}; padding: 15px; margin: 10px 0; border-radius: 4px;">
                        <strong>${signal.title}</strong>
                        <p style="margin: 5px 0;">${signal.message}</p>
                        ${signal.action_window_weeks !== null ? `<p style="color: #666; font-size: 14px;">Action window: ${signal.action_window_weeks} weeks</p>` : ''}
                    </div>
                `).join('');
            }

            // Build suggested dependent scenarios section
            let suggestedHtml = '';
            if (forecastData.suggested_scenarios && forecastData.suggested_scenarios.length > 0) {
                const directionIcons = {
                    'reduce_costs': 'üí∞',
                    'increase_costs': 'üìà',
                    'reduce_revenue': 'üìâ',
                    'increase_revenue': 'üíµ',
                    'timing_change': '‚è∞'
                };
                const confidenceColors = {
                    'high': '#4caf50',
                    'medium': '#ff9800',
                    'low': '#9e9e9e'
                };

                suggestedHtml = `
                    <div style="margin-top: 20px; border-top: 1px solid #e0e0e0; padding-top: 15px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">üîó Related Scenarios to Consider</h4>
                        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Based on this ${scenario.scenario_type.replace('_', ' ')}, you might also want to model:</p>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            ${forecastData.suggested_scenarios.map(s => `
                                <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; flex: 1; min-width: 200px; max-width: 300px; cursor: pointer; transition: all 0.2s;"
                                     onclick="createLinkedScenario('${scenario.id}', '${s.scenario_type}', ${JSON.stringify(s.prefill_params).replace(/"/g, '&quot;')})"
                                     onmouseover="this.style.borderColor='#667eea'; this.style.background='#fff'"
                                     onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='#f8f9fa'">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <span style="font-size: 20px;">${directionIcons[s.direction] || 'üìä'}</span>
                                        <strong style="color: #333;">${s.title}</strong>
                                        <span style="background: ${confidenceColors[s.confidence]}; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px;">${s.confidence}</span>
                                    </div>
                                    <p style="color: #666; font-size: 13px; margin: 0 0 8px 0;">${s.description}</p>
                                    <p style="color: #667eea; font-size: 12px; font-style: italic; margin: 0;">‚Üí ${s.question}</p>
                                    ${s.typical_lag_weeks > 0 ? `<p style="color: #999; font-size: 11px; margin-top: 5px;">Typically takes effect after ${s.typical_lag_weeks} week(s)</p>` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            scenarioCard.innerHTML = `
                <h3>${scenario.name}</h3>
                <p style="color: #666;">Type: ${scenario.scenario_type.replace('_', ' ')}</p>

                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <strong>Impact on Week 13:</strong>
                    <p style="font-size: 24px; color: ${impactColor}; margin: 5px 0;">
                        ${impact >= 0 ? '+' : ''}$${impact.toLocaleString()}
                    </p>
                    <p style="color: #666; font-size: 14px;">
                        Base: $${baseEndingBalance.toLocaleString()} ‚Üí Scenario: $${scenarioEndingBalance.toLocaleString()}
                    </p>
                </div>

                ${signalsHtml ? '<h4>‚ö†Ô∏è Decision Signals:</h4>' + signalsHtml : ''}

                ${suggestedHtml}

                <div class="buttons" style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="viewScenarioForecast('${scenario.id}')">View Full Forecast</button>
                    <button class="btn btn-primary" onclick="confirmScenario('${scenario.id}')">‚úì Confirm & Apply</button>
                    <button class="btn" onclick="discardScenario('${scenario.id}')" style="background: #f44336; color: white;">‚úó Discard</button>
                </div>
            `;

            scenariosList.appendChild(scenarioCard);
        }

        async function viewScenarioForecast(scenarioId) {
            const scenarioData = scenarios.find(s => s.scenario.id === scenarioId);
            if (!scenarioData) return;

            // Create overlay forecast chart showing base vs scenario
            const forecast = scenarioData.forecastData.scenario_forecast;
            const baseForecast = scenarioData.forecastData.base_forecast;

            // Update main chart to show comparison
            const ctx = document.getElementById('forecastChart').getContext('2d');

            if (currentChart) {
                currentChart.destroy();
            }

            const weeks = forecast.weeks;
            const labels = weeks.map(w => `Week ${w.week_number}`);
            const bufferAmount = getBufferAmount();

            console.log('Scenario Chart - Buffer Amount:', bufferAmount, 'Config:', cashBufferConfig);

            // Check scenario forecast for buffer breaches
            const scenarioBalances = weeks.map(w => parseFloat(w.ending_balance));
            const baseBalances = baseForecast.weeks.map(w => parseFloat(w.ending_balance));

            // Color scenario points based on buffer status
            const scenarioPointColors = scenarioBalances.map(balance =>
                balance < bufferAmount ? '#dc3545' : '#667eea'
            );

            // Check for breaches in scenario
            const scenarioBreachWeeks = [];
            scenarioBalances.forEach((balance, index) => {
                if (balance < bufferAmount) {
                    scenarioBreachWeeks.push(index + 1);
                }
            });

            // Check base forecast breaches for comparison
            const baseBreachWeeks = [];
            baseBalances.forEach((balance, index) => {
                if (balance < bufferAmount) {
                    baseBreachWeeks.push(index + 1);
                }
            });

            currentChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Base Forecast',
                            data: baseBalances,
                            borderColor: '#999',
                            backgroundColor: 'rgba(153, 153, 153, 0.1)',
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 4,
                            pointBackgroundColor: baseBalances.map(b => b < bufferAmount ? '#dc3545' : '#999')
                        },
                        {
                            label: 'Scenario Forecast',
                            data: scenarioBalances,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 6,
                            pointBackgroundColor: scenarioPointColors,
                            pointBorderColor: scenarioPointColors,
                            pointBorderWidth: 2
                        },
                        // Buffer line - only show if buffer > 0
                        ...(bufferAmount > 0 ? [{
                            label: 'Cash Buffer (Minimum)',
                            data: Array(weeks.length).fill(bufferAmount),
                            borderColor: '#dc3545',
                            backgroundColor: 'transparent',
                            borderWidth: 3,
                            borderDash: [10, 5],
                            fill: false,
                            tension: 0,
                            pointRadius: 0,
                            pointHoverRadius: 0,
                            order: 0
                        }] : [])
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const value = context.parsed.y;
                                    // Check by label instead of index since buffer may or may not exist
                                    if (context.dataset.label === 'Cash Buffer (Minimum)') {
                                        return `Buffer: $${value.toLocaleString()}`;
                                    }
                                    const status = bufferAmount > 0 && value < bufferAmount ? ' ‚ö†Ô∏è BELOW BUFFER' : '';
                                    return `${context.dataset.label}: $${value.toLocaleString()}${status}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            ticks: {
                                callback: (value) => '$' + value.toLocaleString()
                            }
                        }
                    }
                }
            });

            // Show scenario-specific buffer warning (only if buffer is configured)
            if (bufferAmount > 0) {
                showScenarioBufferWarning(baseBreachWeeks, scenarioBreachWeeks, bufferAmount);
            }

            // Scroll to chart
            document.querySelector('.chart-container').scrollIntoView({ behavior: 'smooth' });
        }

        function showScenarioBufferWarning(baseBreachWeeks, scenarioBreachWeeks, bufferAmount) {
            // Remove existing warning
            const existingWarning = document.getElementById('bufferWarning');
            if (existingWarning) {
                existingWarning.remove();
            }

            const warningDiv = document.createElement('div');
            warningDiv.id = 'bufferWarning';

            // Compare base vs scenario breaches
            const baseHasBreaches = baseBreachWeeks.length > 0;
            const scenarioHasBreaches = scenarioBreachWeeks.length > 0;

            let html = '';

            if (!baseHasBreaches && !scenarioHasBreaches) {
                // Both are safe
                html = `
                    <div style="background: #f0fff0; border: 2px solid #28a745; border-radius: 8px; padding: 20px; margin: 20px 0;">
                        <h3 style="color: #28a745; margin: 0 0 10px 0;">‚úÖ Cash Buffer Status: Safe</h3>
                        <p style="margin: 0;">
                            Both your base forecast and this scenario stay above your minimum cash buffer of <strong>$${bufferAmount.toLocaleString()}</strong>.
                        </p>
                    </div>
                `;
            } else if (baseHasBreaches && !scenarioHasBreaches) {
                // Scenario fixes the breach!
                html = `
                    <div style="background: #f0fff0; border: 2px solid #28a745; border-radius: 8px; padding: 20px; margin: 20px 0;">
                        <h3 style="color: #28a745; margin: 0 0 10px 0;">üéâ This Scenario Fixes Your Buffer Breach!</h3>
                        <p style="margin: 0 0 10px 0;">
                            Your base forecast breaches the buffer in Weeks ${baseBreachWeeks.join(', ')}, but <strong>this scenario keeps you above the $${bufferAmount.toLocaleString()} minimum</strong>.
                        </p>
                        <p style="margin: 0; font-weight: bold; color: #28a745;">
                            Consider confirming this scenario to improve your cash position.
                        </p>
                    </div>
                `;
            } else if (!baseHasBreaches && scenarioHasBreaches) {
                // Scenario creates a breach!
                html = `
                    <div style="background: #fff3f3; border: 2px solid #dc3545; border-radius: 8px; padding: 20px; margin: 20px 0;">
                        <h3 style="color: #dc3545; margin: 0 0 10px 0;">‚ö†Ô∏è Warning: This Scenario Creates a Buffer Breach</h3>
                        <p style="margin: 0 0 10px 0;">
                            Your base forecast is safe, but <strong>this scenario would cause you to fall below your $${bufferAmount.toLocaleString()} buffer</strong>
                            in Week ${scenarioBreachWeeks[0]}.
                        </p>
                        <p style="margin: 0; color: #666;">
                            <strong>Affected weeks:</strong> ${scenarioBreachWeeks.map(w => `Week ${w}`).join(', ')}
                        </p>
                    </div>
                `;
            } else {
                // Both have breaches - compare
                const scenarioImproves = scenarioBreachWeeks.length < baseBreachWeeks.length ||
                    (scenarioBreachWeeks.length === baseBreachWeeks.length && scenarioBreachWeeks[0] > baseBreachWeeks[0]);

                if (scenarioImproves) {
                    html = `
                        <div style="background: #fff9e6; border: 2px solid #ffc107; border-radius: 8px; padding: 20px; margin: 20px 0;">
                            <h3 style="color: #856404; margin: 0 0 10px 0;">üìà This Scenario Improves Your Situation</h3>
                            <p style="margin: 0 0 10px 0;">
                                Both forecasts breach the $${bufferAmount.toLocaleString()} buffer, but this scenario is better:
                            </p>
                            <p style="margin: 0 0 5px 0;">
                                <strong>Base:</strong> Breaches in Weeks ${baseBreachWeeks.join(', ')}
                            </p>
                            <p style="margin: 0;">
                                <strong>Scenario:</strong> Breaches in Weeks ${scenarioBreachWeeks.join(', ')}
                            </p>
                        </div>
                    `;
                } else {
                    html = `
                        <div style="background: #fff3f3; border: 2px solid #dc3545; border-radius: 8px; padding: 20px; margin: 20px 0;">
                            <h3 style="color: #dc3545; margin: 0 0 10px 0;">‚ö†Ô∏è Both Forecasts Breach the Buffer</h3>
                            <p style="margin: 0 0 10px 0;">
                                Neither your base forecast nor this scenario stay above the $${bufferAmount.toLocaleString()} buffer.
                            </p>
                            <p style="margin: 0 0 5px 0;">
                                <strong>Base:</strong> Breaches in Weeks ${baseBreachWeeks.join(', ')}
                            </p>
                            <p style="margin: 0;">
                                <strong>Scenario:</strong> Breaches in Weeks ${scenarioBreachWeeks.join(', ')}
                            </p>
                        </div>
                    `;
                }
            }

            warningDiv.innerHTML = html;

            // Insert after chart
            const chartContainer = document.querySelector('.chart-container');
            if (chartContainer) {
                chartContainer.parentNode.insertBefore(warningDiv, chartContainer.nextSibling);
            }
        }

        async function confirmScenario(scenarioId) {
            if (!confirm('Are you sure you want to apply this scenario? This will update your base forecast.')) {
                return;
            }

            try {
                await fetch(`${API_BASE}/scenarios/scenarios/${scenarioId}/confirm`, {
                    method: 'POST'
                });

                alert('Scenario confirmed! Your forecast has been updated.');
                location.reload();  // Reload to show updated forecast
            } catch (error) {
                console.error('Error confirming scenario:', error);
                alert('Error confirming scenario: ' + error.message);
            }
        }

        async function discardScenario(scenarioId) {
            try {
                await fetch(`${API_BASE}/scenarios/scenarios/${scenarioId}`, {
                    method: 'DELETE'
                });

                // Remove from UI
                document.getElementById(`scenario-${scenarioId}`).remove();

                // Remove from scenarios array
                scenarios = scenarios.filter(s => s.scenario.id !== scenarioId);
            } catch (error) {
                console.error('Error discarding scenario:', error);
                alert('Error discarding scenario: ' + error.message);
            }
        }

        // Add a linked layer to an existing scenario (instead of creating a new one)
        async function createLinkedScenario(parentScenarioId, scenarioType, prefillParams) {
            // Find the parent scenario to get context
            const parentData = scenarios.find(s => s.scenario.id === parentScenarioId);
            if (!parentData) {
                alert('Parent scenario not found');
                return;
            }

            // Format the scenario type for display
            const typeDisplay = scenarioType.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

            // Show a modal to collect layer parameters
            showLayerModal(parentScenarioId, parentData.scenario.name, scenarioType, typeDisplay, prefillParams);
        }

        // Show modal for adding layer parameters
        function showLayerModal(parentScenarioId, parentName, layerType, layerTypeDisplay, prefillParams) {
            // Remove existing modal if any
            const existingModal = document.getElementById('layerModal');
            if (existingModal) existingModal.remove();

            // Default date 2 weeks out
            const defaultDate = new Date(Date.now() + 14*24*60*60*1000).toISOString().split('T')[0];

            // Build form fields based on layer type
            let fieldsHtml = '';
            let helpText = '';

            if (layerType === 'contractor_loss' || layerType === 'decreased_expense') {
                helpText = layerType === 'contractor_loss'
                    ? 'Model ending a contractor relationship to reduce expenses.'
                    : 'Model reducing or canceling an expense.';
                fieldsHtml = `
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Monthly Amount to Reduce ($)</label>
                        <input type="number" id="layerAmount" value="${prefillParams.amount || 5000}" min="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Effective Date</label>
                        <input type="date" id="layerEffectiveDate" value="${defaultDate}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Description (optional)</label>
                        <input type="text" id="layerDescription" placeholder="e.g., Cancel AWS subscription" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                `;
            } else if (layerType === 'firing') {
                helpText = 'Model reducing permanent staff to lower payroll costs.';
                fieldsHtml = `
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Last Day</label>
                        <input type="date" id="layerEffectiveDate" value="${defaultDate}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Monthly Salary Saved ($)</label>
                        <input type="number" id="layerAmount" value="${prefillParams.amount || 8000}" min="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Severance Amount ($)</label>
                        <input type="number" id="layerSeverance" value="0" min="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                `;
            } else if (layerType === 'payment_delay_out') {
                helpText = 'Model delaying vendor payments to preserve cash.';
                fieldsHtml = `
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Delay by (weeks)</label>
                        <input type="number" id="layerDelayWeeks" value="${prefillParams.delay_weeks || 2}" min="1" max="12" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Total Amount to Delay ($)</label>
                        <input type="number" id="layerAmount" value="${prefillParams.amount || 10000}" min="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                `;
            } else if (layerType === 'hiring' || layerType === 'contractor_gain') {
                helpText = layerType === 'hiring'
                    ? 'Model adding a new full-time team member.'
                    : 'Model bringing on additional contractor capacity.';
                fieldsHtml = `
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Start Date</label>
                        <input type="date" id="layerEffectiveDate" value="${defaultDate}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Monthly ${layerType === 'hiring' ? 'Salary' : 'Cost'} ($)</label>
                        <input type="number" id="layerAmount" value="${prefillParams.amount || (layerType === 'hiring' ? 8000 : 5000)}" min="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    ${layerType === 'hiring' ? `
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Onboarding Costs ($)</label>
                        <input type="number" id="layerOnboarding" value="${prefillParams.onboarding || 2000}" min="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    ` : ''}
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Role/Description (optional)</label>
                        <input type="text" id="layerDescription" placeholder="e.g., Frontend developer" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                `;
            } else if (layerType === 'client_gain') {
                helpText = 'Model winning new client revenue.';
                fieldsHtml = `
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Start Date</label>
                        <input type="date" id="layerEffectiveDate" value="${defaultDate}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Monthly Revenue ($)</label>
                        <input type="number" id="layerAmount" value="${prefillParams.amount || 10000}" min="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Client Name (optional)</label>
                        <input type="text" id="layerDescription" placeholder="e.g., Acme Corp" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                `;
            } else if (layerType === 'increased_expense') {
                helpText = 'Model adding a new expense or increasing an existing one.';
                const category = prefillParams.category || '';
                fieldsHtml = `
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Expense Category</label>
                        <select id="layerCategory" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="software" ${category === 'software' ? 'selected' : ''}>Software/Tools</option>
                            <option value="onboarding" ${category === 'onboarding' ? 'selected' : ''}>Onboarding/Equipment</option>
                            <option value="office" ${category === 'office' ? 'selected' : ''}>Office/Facilities</option>
                            <option value="marketing" ${category === 'marketing' ? 'selected' : ''}>Marketing</option>
                            <option value="other" ${!category || category === 'other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Monthly Amount ($)</label>
                        <input type="number" id="layerAmount" value="${prefillParams.amount || 1000}" min="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Expense Type</label>
                        <select id="layerExpenseType" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <option value="recurring">Recurring (monthly)</option>
                            <option value="one_off" ${prefillParams.expense_type === 'one_off' ? 'selected' : ''}>One-time</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Effective Date</label>
                        <input type="date" id="layerEffectiveDate" value="${defaultDate}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Description (optional)</label>
                        <input type="text" id="layerDescription" placeholder="e.g., New project management tool" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                `;
            } else if (layerType === 'client_change' || layerType === 'client_loss') {
                helpText = layerType === 'client_loss'
                    ? 'Model losing a client and the associated revenue.'
                    : 'Model changes to an existing client relationship.';
                fieldsHtml = `
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Effective Date</label>
                        <input type="date" id="layerEffectiveDate" value="${defaultDate}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Monthly Revenue Impact ($)</label>
                        <input type="number" id="layerAmount" value="${prefillParams.amount || 5000}" min="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Client/Description (optional)</label>
                        <input type="text" id="layerDescription" placeholder="e.g., Acme Corp scope reduction" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                `;
            } else {
                // Generic fallback
                helpText = 'Enter the details for this change.';
                fieldsHtml = `
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Amount ($)</label>
                        <input type="number" id="layerAmount" value="${prefillParams.amount || 5000}" min="0" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                    <div class="form-group" style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500;">Effective Date</label>
                        <input type="date" id="layerEffectiveDate" value="${defaultDate}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    </div>
                `;
            }

            const modal = document.createElement('div');
            modal.id = 'layerModal';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000;';
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #333;">Add ${layerTypeDisplay}</h3>
                        <button onclick="closeLayerModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #999;">&times;</button>
                    </div>
                    <p style="color: #667eea; font-size: 14px; margin-bottom: 8px; font-weight: 500;">Adding to: ${parentName}</p>
                    <p style="color: #666; font-size: 13px; margin-bottom: 20px; padding: 10px; background: #f8f9fa; border-radius: 6px;">${helpText}</p>

                    ${fieldsHtml}

                    <div style="display: flex; gap: 10px; margin-top: 25px;">
                        <button onclick="closeLayerModal()" style="flex: 1; padding: 12px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; font-weight: 500;">Cancel</button>
                        <button id="submitLayerBtn" onclick="submitLayer('${parentScenarioId}', '${layerType}', '${layerTypeDisplay}')" style="flex: 1; padding: 12px; border: none; background: #667eea; color: white; border-radius: 6px; cursor: pointer; font-weight: bold;">Add Layer</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function closeLayerModal() {
            const modal = document.getElementById('layerModal');
            if (modal) modal.remove();
        }

        async function submitLayer(parentScenarioId, layerType, layerTypeDisplay) {
            // Show loading state
            const submitBtn = document.getElementById('submitLayerBtn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Adding...';
            }

            // Collect parameters from the form
            const parameters = {};

            const amountInput = document.getElementById('layerAmount');
            if (amountInput) {
                parameters.amount = parseFloat(amountInput.value) || 0;
                parameters.monthly_estimate = parameters.amount;  // Alias for some handlers
                parameters.monthly_revenue = parameters.amount;   // Alias for client_gain
                parameters.monthly_salary = parameters.amount;    // Alias for hiring
            }

            const effectiveDateInput = document.getElementById('layerEffectiveDate');
            if (effectiveDateInput && effectiveDateInput.value) {
                parameters.effective_date = effectiveDateInput.value;
                parameters.end_date = effectiveDateInput.value;    // Alias for firing/contractor_loss
                parameters.start_date = effectiveDateInput.value;  // Alias for hiring/contractor_gain
            }

            const severanceInput = document.getElementById('layerSeverance');
            if (severanceInput) {
                parameters.severance_amount = parseFloat(severanceInput.value) || 0;
            }

            const delayWeeksInput = document.getElementById('layerDelayWeeks');
            if (delayWeeksInput) {
                parameters.delay_weeks = parseInt(delayWeeksInput.value) || 2;
            }

            const descriptionInput = document.getElementById('layerDescription');
            if (descriptionInput && descriptionInput.value) {
                parameters.expense_name = descriptionInput.value;
                parameters.description = descriptionInput.value;
                parameters.client_name = descriptionInput.value;  // For client scenarios
            }

            // Handle category dropdown
            const categoryInput = document.getElementById('layerCategory');
            if (categoryInput) {
                parameters.category = categoryInput.value;
            }

            // Handle expense type dropdown
            const expenseTypeInput = document.getElementById('layerExpenseType');
            if (expenseTypeInput) {
                parameters.expense_type = expenseTypeInput.value;
                parameters.is_recurring = expenseTypeInput.value === 'recurring';
            }

            // Handle onboarding costs for hiring
            const onboardingInput = document.getElementById('layerOnboarding');
            if (onboardingInput) {
                parameters.onboarding_costs = parseFloat(onboardingInput.value) || 0;
            }

            closeLayerModal();

            try {
                // Add the layer to the existing scenario
                const response = await fetch(`${API_BASE}/scenarios/scenarios/${parentScenarioId}/add-layer`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        layer_type: layerType,
                        layer_name: layerTypeDisplay,
                        parameters: parameters
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.detail || 'Failed to add layer');
                }

                const result = await response.json();

                // Refresh the scenario forecast to show combined impact
                const forecastResponse = await fetch(`${API_BASE}/scenarios/scenarios/${parentScenarioId}/forecast`);
                const forecastData = await forecastResponse.json();

                // Update the scenario in our local array
                const scenarioIndex = scenarios.findIndex(s => s.scenario.id === parentScenarioId);
                if (scenarioIndex >= 0) {
                    scenarios[scenarioIndex].forecastData = forecastData;
                    scenarios[scenarioIndex].scenario.linked_scenarios = result.linked_scenarios;
                }

                // Update the display
                const scenarioCard = document.getElementById(`scenario-${parentScenarioId}`);
                if (scenarioCard) {
                    const parentData = scenarios[scenarioIndex];
                    displayScenarioUpdated(parentData.scenario, forecastData, scenarioCard);
                }

                // Show success toast instead of alert
                showToast(`‚úì ${layerTypeDisplay} added to scenario`, 'success');

                // Update the chart to show the combined scenario impact
                viewScenarioForecast(parentScenarioId);

            } catch (error) {
                console.error('Error adding layer:', error);
                showToast('Error adding layer: ' + error.message, 'error');
            }
        }

        // Toast notification helper
        function showToast(message, type = 'success') {
            const existingToast = document.getElementById('toast');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.id = 'toast';
            toast.style.cssText = `
                position: fixed;
                bottom: 30px;
                left: 50%;
                transform: translateX(-50%);
                padding: 15px 30px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 2000;
                animation: fadeInUp 0.3s ease;
                background: ${type === 'success' ? '#4caf50' : '#f44336'};
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Update an existing scenario card with new data
        function displayScenarioUpdated(scenario, forecastData, existingCard) {
            const baseEndingBalance = parseFloat(forecastData.base_forecast.weeks[forecastData.base_forecast.weeks.length - 1].ending_balance);
            const scenarioEndingBalance = parseFloat(forecastData.scenario_forecast.weeks[forecastData.scenario_forecast.weeks.length - 1].ending_balance);
            const impact = scenarioEndingBalance - baseEndingBalance;
            const impactColor = impact >= 0 ? '#4caf50' : '#f44336';

            // Build linked layers display
            let layersHtml = '';
            if (scenario.linked_scenarios && scenario.linked_scenarios.length > 0) {
                layersHtml = `
                    <div style="background: #e8eaf6; padding: 10px; border-radius: 6px; margin: 10px 0;">
                        <strong style="color: #667eea;">üìö Combined Layers (${scenario.linked_scenarios.length + 1}):</strong>
                        <ul style="margin: 5px 0 0 20px; padding: 0;">
                            <li style="color: #333;">${scenario.name} (Primary)</li>
                            ${scenario.linked_scenarios.map(l => `<li style="color: #333;">${l.layer_name}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            // Build decision signals
            let signalsHtml = '';
            if (forecastData.decision_signals && forecastData.decision_signals.signals) {
                signalsHtml = forecastData.decision_signals.signals.map(signal => `
                    <div style="background: ${signal.severity === 'red' ? '#ffebee' : '#fff3e0'}; border-left: 4px solid ${signal.severity === 'red' ? '#f44336' : '#ff9800'}; padding: 15px; margin: 10px 0; border-radius: 4px;">
                        <strong>${signal.title}</strong>
                        <p style="margin: 5px 0;">${signal.message}</p>
                        ${signal.action_window_weeks !== null ? `<p style="color: #666; font-size: 14px;">Action window: ${signal.action_window_weeks} weeks</p>` : ''}
                    </div>
                `).join('');
            }

            // Build suggested scenarios
            let suggestedHtml = '';
            if (forecastData.suggested_scenarios && forecastData.suggested_scenarios.length > 0) {
                const directionIcons = {
                    'reduce_costs': 'üí∞',
                    'increase_costs': 'üìà',
                    'reduce_revenue': 'üìâ',
                    'increase_revenue': 'üíµ',
                    'timing_change': '‚è∞'
                };
                const confidenceColors = {
                    'high': '#4caf50',
                    'medium': '#ff9800',
                    'low': '#9e9e9e'
                };

                suggestedHtml = `
                    <div style="margin-top: 20px; border-top: 1px solid #e0e0e0; padding-top: 15px;">
                        <h4 style="color: #667eea; margin-bottom: 10px;">üîó Add More Related Changes</h4>
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            ${forecastData.suggested_scenarios.map(s => `
                                <div style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 12px; flex: 1; min-width: 200px; max-width: 300px; cursor: pointer; transition: all 0.2s;"
                                     onclick="createLinkedScenario('${scenario.id}', '${s.scenario_type}', ${JSON.stringify(s.prefill_params).replace(/"/g, '&quot;')})"
                                     onmouseover="this.style.borderColor='#667eea'; this.style.background='#fff'"
                                     onmouseout="this.style.borderColor='#e0e0e0'; this.style.background='#f8f9fa'">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <span style="font-size: 20px;">${directionIcons[s.direction] || 'üìä'}</span>
                                        <strong style="color: #333;">${s.title}</strong>
                                        <span style="background: ${confidenceColors[s.confidence]}; color: white; font-size: 10px; padding: 2px 6px; border-radius: 10px;">${s.confidence}</span>
                                    </div>
                                    <p style="color: #666; font-size: 13px; margin: 0;">${s.description}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            existingCard.innerHTML = `
                <h3>${scenario.name}</h3>
                <p style="color: #666;">Type: ${scenario.scenario_type.replace('_', ' ')}</p>

                ${layersHtml}

                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <strong>Combined Impact on Week 13:</strong>
                    <p style="font-size: 24px; color: ${impactColor}; margin: 5px 0;">
                        ${impact >= 0 ? '+' : ''}$${impact.toLocaleString()}
                    </p>
                    <p style="color: #666; font-size: 14px;">
                        Base: $${baseEndingBalance.toLocaleString()} ‚Üí Scenario: $${scenarioEndingBalance.toLocaleString()}
                    </p>
                </div>

                ${signalsHtml ? '<h4>‚ö†Ô∏è Decision Signals:</h4>' + signalsHtml : ''}

                ${suggestedHtml}

                <div class="buttons" style="margin-top: 20px;">
                    <button class="btn btn-secondary" onclick="viewScenarioForecast('${scenario.id}')">View Full Forecast</button>
                    <button class="btn btn-primary" onclick="confirmScenario('${scenario.id}')">‚úì Confirm & Apply</button>
                    <button class="btn" onclick="discardScenario('${scenario.id}')" style="background: #f44336; color: white;">‚úó Discard</button>
                </div>
            `;
        }

        // ============================================================
        // TAMI CHAT FUNCTIONS
        // ============================================================

        // TAMI conversation state
        let tamiConversation = [];
        let tamiActiveScenarioId = null;
        let tamiIsTyping = false;

        // Simple markdown to HTML converter
        function markdownToHtml(md) {
            if (!md) return '';
            return md
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code style="background:#f0f0f0;padding:2px 4px;border-radius:3px;">$1</code>')
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n/g, '<br>')
                .replace(/- (.*?)(?=\n|$)/g, '<li>$1</li>')
                .replace(/<li>/g, '<ul style="margin:8px 0 0 16px;padding:0;"><li>')
                .replace(/<\/li>(?![\s\S]*<li>)/g, '</li></ul>');
        }

        // Send message to TAMI
        async function sendTamiMessage() {
            const input = document.getElementById('tamiInput');
            const message = input.value.trim();

            if (!message || tamiIsTyping) return;

            // Clear input
            input.value = '';

            // Add user message to UI
            addTamiMessage(message, 'user');

            // Add to conversation history
            tamiConversation.push({
                role: 'user',
                content: message
            });

            // Show typing indicator
            showTamiTyping(true);
            setTamiStatus('Thinking...');

            try {
                // Call TAMI API
                const response = await fetch(`${API_BASE}/tami/chat`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: currentUserId,
                        message: message,
                        conversation_history: tamiConversation.slice(-10), // Last 10 messages
                        active_scenario_id: tamiActiveScenarioId
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to get response from TAMI');
                }

                const data = await response.json();
                const tamiResponse = data.response;

                // Add TAMI response to UI
                addTamiMessage(
                    tamiResponse.message_markdown,
                    'tami',
                    tamiResponse.ui_hints
                );

                // Add to conversation history
                tamiConversation.push({
                    role: 'assistant',
                    content: tamiResponse.message_markdown
                });

                // Handle UI hints
                if (tamiResponse.ui_hints) {
                    handleTamiUiHints(tamiResponse.ui_hints);
                }

                // Check if any tool calls were made (scenario created)
                if (data.tool_calls_made && data.tool_calls_made.length > 0) {
                    for (const toolCall of data.tool_calls_made) {
                        if (toolCall.result && toolCall.result.scenario_id) {
                            tamiActiveScenarioId = toolCall.result.scenario_id;
                            // Refresh scenarios list
                            await loadActiveScenarios();
                        }
                    }
                }

                setTamiStatus('Ready');

            } catch (error) {
                console.error('TAMI error:', error);
                addTamiMessage(
                    "I'm having trouble connecting right now. Please try again in a moment.",
                    'tami'
                );
                setTamiStatus('Error');
            } finally {
                showTamiTyping(false);
            }
        }

        // Add message to TAMI chat
        function addTamiMessage(content, sender, uiHints = null) {
            const messagesDiv = document.getElementById('tamiMessages');

            const messageDiv = document.createElement('div');
            messageDiv.className = `tami-message ${sender}`;

            const avatar = sender === 'tami' ? 'ü§ñ' : 'üë§';
            const avatarClass = sender;

            let actionsHtml = '';
            if (uiHints && uiHints.suggested_actions && uiHints.suggested_actions.length > 0) {
                actionsHtml = `
                    <div class="tami-actions">
                        ${uiHints.suggested_actions.map(action => `
                            <button class="tami-action-btn" onclick="handleTamiAction(${JSON.stringify(action).replace(/"/g, '&quot;')})">
                                ${action.label}
                            </button>
                        `).join('')}
                    </div>
                `;
            }

            messageDiv.innerHTML = `
                <div class="tami-avatar ${avatarClass}">${avatar}</div>
                <div class="tami-bubble">
                    ${markdownToHtml(content)}
                    ${actionsHtml}
                </div>
            `;

            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Show/hide typing indicator
        function showTamiTyping(show) {
            tamiIsTyping = show;
            const messagesDiv = document.getElementById('tamiMessages');

            // Remove existing typing indicator
            const existing = document.getElementById('tamiTypingIndicator');
            if (existing) existing.remove();

            if (show) {
                const typingDiv = document.createElement('div');
                typingDiv.id = 'tamiTypingIndicator';
                typingDiv.className = 'tami-message tami';
                typingDiv.innerHTML = `
                    <div class="tami-avatar tami">ü§ñ</div>
                    <div class="tami-bubble">
                        <div class="tami-typing">
                            <div class="tami-typing-dot"></div>
                            <div class="tami-typing-dot"></div>
                            <div class="tami-typing-dot"></div>
                        </div>
                    </div>
                `;
                messagesDiv.appendChild(typingDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }

            // Disable/enable send button
            document.getElementById('tamiSendBtn').disabled = show;
        }

        // Set TAMI status
        function setTamiStatus(status) {
            document.getElementById('tamiStatus').textContent = status;
        }

        // Handle UI hints from TAMI response
        function handleTamiUiHints(hints) {
            const banner = document.getElementById('scenarioBanner');

            if (hints.show_scenario_banner) {
                banner.classList.remove('hidden');
            } else {
                banner.classList.add('hidden');
            }
        }

        // Handle action button clicks
        async function handleTamiAction(action) {
            if (action.action === 'call_tool' && action.tool_name) {
                // Execute the tool via chat
                const toolDescription = action.label;
                addTamiMessage(`Executing: ${toolDescription}...`, 'user');

                try {
                    let endpoint, body;

                    // Handle both old (dot) and new (underscore) tool name formats
                    const toolName = action.tool_name.replace(/\./g, '_');

                    if (toolName === 'scenario_create_or_update_layer') {
                        endpoint = `${API_BASE}/tami/scenario/layer/create_or_update`;
                        body = {
                            user_id: currentUserId,
                            scenario_type: action.tool_args?.scenario_type || 'client_loss',
                            scope: action.tool_args?.scope || {},
                            params: action.tool_args?.params || {},
                            name: action.tool_args?.name || action.label
                        };
                    } else if (toolName === 'scenario_discard_layer') {
                        endpoint = `${API_BASE}/tami/scenario/layer/discard?user_id=${currentUserId}`;
                        body = action.tool_args;
                    } else if (toolName === 'scenario_get_suggestions') {
                        endpoint = `${API_BASE}/tami/scenario/suggestions?user_id=${currentUserId}`;
                        const response = await fetch(endpoint);
                        const data = await response.json();
                        addTamiMessage(
                            `Here are some suggested scenarios based on your current forecast:\n\n${JSON.stringify(data.suggestions, null, 2)}`,
                            'tami'
                        );
                        return;
                    } else if (toolName === 'plan_build_goal_scenarios') {
                        endpoint = `${API_BASE}/tami/plan/goal`;
                        body = {
                            user_id: currentUserId,
                            goal: action.tool_args?.goal || action.label,
                            constraints: action.tool_args?.constraints || {}
                        };
                    } else {
                        // For unknown tools or simple explore actions, send as a follow-up chat message
                        await sendTamiMessage(`Tell me more about: ${action.label}`);
                        return;
                    }

                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });

                    const result = await response.json();

                    if (result.scenario_id) {
                        tamiActiveScenarioId = result.scenario_id;
                        await loadActiveScenarios();
                    }

                    addTamiMessage(result.message || 'Action completed.', 'tami');

                } catch (error) {
                    addTamiMessage(`Error executing action: ${error.message}`, 'tami');
                }
            } else if (action.action === 'send_message' || action.message) {
                // Handle actions that should send a message to TAMI
                await sendTamiMessage(action.message || action.label);
            } else {
                // Default: send the label as a follow-up question
                await sendTamiMessage(`Tell me more about: ${action.label}`);
            }
        }

        // Confirm scenario from banner
        async function tamiConfirmScenario() {
            if (!tamiActiveScenarioId) return;

            try {
                await confirmScenario(tamiActiveScenarioId);
                tamiActiveScenarioId = null;
                document.getElementById('scenarioBanner').classList.add('hidden');
                addTamiMessage('Scenario confirmed and applied to your base forecast.', 'tami');
            } catch (error) {
                addTamiMessage(`Error confirming scenario: ${error.message}`, 'tami');
            }
        }

        // Discard scenario from banner
        async function tamiDiscardScenario() {
            if (!tamiActiveScenarioId) return;

            try {
                await discardScenario(tamiActiveScenarioId);
                tamiActiveScenarioId = null;
                document.getElementById('scenarioBanner').classList.add('hidden');
                addTamiMessage('Scenario discarded.', 'tami');
            } catch (error) {
                addTamiMessage(`Error discarding scenario: ${error.message}`, 'tami');
            }
        }

        // Update scenario banner
        function updateScenarioBanner(scenarioName, show = true) {
            const banner = document.getElementById('scenarioBanner');
            const nameSpan = document.getElementById('scenarioBannerName');

            if (show && scenarioName) {
                nameSpan.textContent = scenarioName;
                banner.classList.remove('hidden');
            } else {
                banner.classList.add('hidden');
            }
        }
    </script>
</body>
</html>
